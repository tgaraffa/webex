{"version":3,"names":["sym","MetricsBatcher","Batcher","extend","namespace","prepareItem","item","env","process","NODE_ENV","appType","config","time","version","webex","resolve","prepareRequest","queue","map","postTime","submitHttpRequest","payload","request","method","service","resource","body","metrics","handleHttpSuccess","res","all","options","acceptItem","handleHttpError","reason","WebexHttpError","NetworkOrCORSError","logger","warn","delay","nextDelay","batcherRetryPlateau","safeSetTimeout","rerequest","prototype","getDeferredForRequest","then","defer","req","enqueue","bounce","catch","reject","fingerprintRequest","fingerprintResponse"],"sources":["batcher.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {Batcher, WebexHttpError} from '@webex/webex-core';\nimport {safeSetTimeout} from '@webex/common-timers';\n\nconst sym = Symbol('metric id');\n\nconst MetricsBatcher = Batcher.extend({\n  namespace: 'Metrics',\n\n  prepareItem(item) {\n    // Keep non-prod data out of metrics\n    const env = process.env.NODE_ENV === 'production' ? null : 'TEST';\n\n    item.appType = item.appType || this.config.appType;\n    item.env = item.env || env;\n    item.time = item.time || Date.now();\n    item.version = item.version || this.webex.version;\n\n    return Promise.resolve(item);\n  },\n\n  prepareRequest(queue) {\n    return Promise.resolve(queue.map((item) => {\n      item.postTime = item.postTime || Date.now();\n\n      return item;\n    }));\n  },\n\n  submitHttpRequest(payload) {\n    return this.webex.request({\n      method: 'POST',\n      service: 'metrics',\n      resource: 'metrics',\n      body: {\n        metrics: payload\n      }\n    });\n  },\n\n  handleHttpSuccess(res) {\n    return Promise.all(res.options.body.metrics.map((item) => this.acceptItem(item)));\n  },\n\n  handleHttpError(reason) {\n    if (reason instanceof WebexHttpError.NetworkOrCORSError) {\n      this.logger.warn('metrics-batcher: received network error submitting metrics, reenqueuing payload');\n\n      return Promise.all(reason.options.body.metrics.map((item) => new Promise((resolve) => {\n        const delay = item[sym].nextDelay;\n\n        if (delay < this.config.batcherRetryPlateau) {\n          item[sym].nextDelay *= 2;\n        }\n        safeSetTimeout(() => {\n          resolve(this.rerequest(item));\n        }, delay);\n      })));\n    }\n\n    return Reflect.apply(Batcher.prototype.handleHttpError, this, [reason]);\n  },\n\n  rerequest(item) {\n    return Promise.all([\n      this.getDeferredForRequest(item),\n      this.prepareItem(item)\n    ])\n      .then(([defer, req]) => {\n        this.enqueue(req)\n          .then(() => this.bounce())\n          .catch((reason) => defer.reject(reason));\n      });\n  },\n\n  fingerprintRequest(item) {\n    item[sym] = item[sym] || {\n      nextDelay: 1000\n    };\n\n    return Promise.resolve(item[sym]);\n  },\n\n  fingerprintResponse(item) {\n    return Promise.resolve(item[sym]);\n  }\n});\n\nexport default MetricsBatcher;\n"],"mappings":"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"}