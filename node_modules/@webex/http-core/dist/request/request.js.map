{"version":3,"names":["prepareOptions","options","responseType","encoding","withCredentials","jar","isBuffer","body","detect","then","type","headers","resolve","doRequest","logger","r","request","error","response","warn","Buffer","from","statusCode","method","url","on","total","loaded","data","length","download","emit","ProgressEvent","_request"],"sources":["request.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport request from 'request';\nimport {Buffer} from 'safe-buffer';\nimport {isBuffer} from '@webex/common';\n\nimport {detect} from '../lib/detect';\nimport ProgressEvent from '../progress-event';\n\n/**\n * @param {Object} options\n * @private\n * @returns {Promise}\n */\nfunction prepareOptions(options) {\n  if (options.responseType === 'buffer' || options.responseType === 'blob') {\n    options.encoding = null;\n  }\n\n  if (options.withCredentials) {\n    options.jar = true;\n  }\n\n  if (isBuffer(options.body)) {\n    return detect(options.body)\n      .then((type) => {\n        options.headers['content-type'] = type;\n\n        return options;\n      });\n  }\n\n  return Promise.resolve(options);\n}\n\n/**\n * @param {Object} options\n * @private\n * @returns {Promise}\n */\nfunction doRequest(options) {\n  return new Promise((resolve) => {\n    const {logger} = options;\n\n    const r = request(options, (error, response) => {\n      if (error) {\n        logger.warn(error);\n      }\n\n      if (response) {\n        response.options = options;\n\n        // I'm not sure why this line is necessary. request seems to be creating\n        // buffers that aren't Buffers.\n        if (options.responseType === 'buffer' && response.body.type === 'Buffer' && !isBuffer(response.body)) {\n          response.body = Buffer.from(response.body);\n        }\n\n        if (isBuffer(response.body) && !response.body.type) {\n          resolve(detect(response.body)\n            .then((type) => {\n              response.body.type = type;\n\n              return response;\n            }));\n\n          return;\n        }\n\n        resolve(response);\n      }\n      else {\n        // Make a network error behave like a browser network error.\n        resolve({\n          statusCode: 0,\n          options,\n          headers: options.headers,\n          method: options.method,\n          url: options.url,\n          body: error\n        });\n      }\n    });\n\n    r.on('response', (response) => {\n      const total = parseInt(response.headers['content-length'], 10);\n      let loaded = 0;\n\n      response.on('data', (data) => {\n        loaded += data.length;\n        options.download.emit('progress', new ProgressEvent(loaded, total));\n      });\n    });\n  });\n}\n\n/**\n * @name request\n * @param {Object} options\n * @returns {Promise}\n */\nexport default function _request(options) {\n  return prepareOptions(options)\n    .then(doRequest);\n}\n"],"mappings":"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"}