{"version":3,"names":["W","M","WeakMappedMappedMap","make","flights","oneFlight","params","length","oneFlightDecorator","options","cacheFailures","cacheSuccesses","keyFactory","target","prop","descriptor","key","value","oneFlightExecutor","fn","innerKey","args","flight","get","catch","reason","delete","reject","then","result","set","prototype"],"sources":["one-flight.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {wrap} from 'lodash';\n\nimport make from './template-container';\n\n// Alias Map and WeakMap to get around a babel compiler bug\nconst W = WeakMap;\nconst M = Map;\nconst WeakMappedMappedMap = make(W, M, M);\n\nconst flights = new WeakMappedMappedMap();\n\n/**\n * @memberof Util\n * @param {Object} options\n * @param {Function} options.keyFactory\n * @param {boolean} options.cacheFailures\n * @param {boolean} options.cacheSuccesses\n * @returns {Function}\n */\nexport default function oneFlight(...params) {\n  if (params.length === 3) {\n    return Reflect.apply(oneFlightDecorator, null, params);\n  }\n\n  const options = params[0] || {};\n\n  const {\n    cacheFailures,\n    cacheSuccesses,\n    keyFactory\n  } = options;\n\n  return oneFlightDecorator;\n\n  /**\n   * @param {Object} target\n   * @param {string} prop\n   * @param {Object} descriptor\n   * @private\n   * @returns {Object}\n   */\n  function oneFlightDecorator(target, prop, descriptor) {\n    const key = prop;\n\n    descriptor.value = wrap(descriptor.value, function oneFlightExecutor(fn, ...args) {\n      let innerKey = key;\n\n      if (keyFactory) {\n        innerKey = `${innerKey}_${keyFactory(...args)}`;\n      }\n\n      /* eslint no-invalid-this: [0] */\n      let flight = flights.get(this, target, innerKey);\n\n      if (flight) {\n        return flight;\n      }\n\n      flight = Reflect.apply(fn, this, args);\n      if (!cacheFailures && flight && flight.catch) {\n        flight = flight.catch((reason) => {\n          flights.delete(this, target, innerKey);\n\n          return Promise.reject(reason);\n        });\n      }\n\n      if (!cacheSuccesses && flight && flight.then) {\n        flight = flight.then((result) => {\n          flights.delete(this, target, innerKey);\n\n          return result;\n        });\n      }\n\n      flights.set(this, target, innerKey, flight);\n\n      return flight;\n    });\n\n    // This *should* make decorators compatible with AmpersandState class\n    // definitions\n    if (typeof target === 'object' && !target.prototype) {\n      target[prop] = descriptor.value;\n    }\n\n    return descriptor;\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;AAMA;;AAEA;AACA,IAAMA,CAAC,mBAAP;AACA,IAAMC,CAAC,eAAP;AACA,IAAMC,mBAAmB,GAAG,IAAAC,0BAAA,EAAKH,CAAL,EAAQC,CAAR,EAAWA,CAAX,CAA5B;AAEA,IAAMG,OAAO,GAAG,IAAIF,mBAAJ,EAAhB;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACe,SAASG,SAAT,GAA8B;EAAA,kCAARC,MAAQ;IAARA,MAAQ;EAAA;;EAC3C,IAAIA,MAAM,CAACC,MAAP,KAAkB,CAAtB,EAAyB;IACvB,OAAO,oBAAcC,kBAAd,EAAkC,IAAlC,EAAwCF,MAAxC,CAAP;EACD;;EAED,IAAMG,OAAO,GAAGH,MAAM,CAAC,CAAD,CAAN,IAAa,EAA7B;EAEA,IACEI,aADF,GAIID,OAJJ,CACEC,aADF;EAAA,IAEEC,cAFF,GAIIF,OAJJ,CAEEE,cAFF;EAAA,IAGEC,UAHF,GAIIH,OAJJ,CAGEG,UAHF;EAMA,OAAOJ,kBAAP;EAEA;AACF;AACA;AACA;AACA;AACA;AACA;;EACE,SAASA,kBAAT,CAA4BK,MAA5B,EAAoCC,IAApC,EAA0CC,UAA1C,EAAsD;IACpD,IAAMC,GAAG,GAAGF,IAAZ;IAEAC,UAAU,CAACE,KAAX,GAAmB,oBAAKF,UAAU,CAACE,KAAhB,EAAuB,SAASC,iBAAT,CAA2BC,EAA3B,EAAwC;MAAA;;MAChF,IAAIC,QAAQ,GAAGJ,GAAf;;MADgF,mCAANK,IAAM;QAANA,IAAM;MAAA;;MAGhF,IAAIT,UAAJ,EAAgB;QACdQ,QAAQ,aAAMA,QAAN,cAAkBR,UAAU,MAAV,SAAcS,IAAd,CAAlB,CAAR;MACD;MAED;;;MACA,IAAIC,MAAM,GAAGlB,OAAO,CAACmB,GAAR,CAAY,IAAZ,EAAkBV,MAAlB,EAA0BO,QAA1B,CAAb;;MAEA,IAAIE,MAAJ,EAAY;QACV,OAAOA,MAAP;MACD;;MAEDA,MAAM,GAAG,oBAAcH,EAAd,EAAkB,IAAlB,EAAwBE,IAAxB,CAAT;;MACA,IAAI,CAACX,aAAD,IAAkBY,MAAlB,IAA4BA,MAAM,CAACE,KAAvC,EAA8C;QAC5CF,MAAM,GAAGA,MAAM,CAACE,KAAP,CAAa,UAACC,MAAD,EAAY;UAChCrB,OAAO,CAACsB,MAAR,CAAe,KAAf,EAAqBb,MAArB,EAA6BO,QAA7B;UAEA,OAAO,iBAAQO,MAAR,CAAeF,MAAf,CAAP;QACD,CAJQ,CAAT;MAKD;;MAED,IAAI,CAACd,cAAD,IAAmBW,MAAnB,IAA6BA,MAAM,CAACM,IAAxC,EAA8C;QAC5CN,MAAM,GAAGA,MAAM,CAACM,IAAP,CAAY,UAACC,MAAD,EAAY;UAC/BzB,OAAO,CAACsB,MAAR,CAAe,KAAf,EAAqBb,MAArB,EAA6BO,QAA7B;UAEA,OAAOS,MAAP;QACD,CAJQ,CAAT;MAKD;;MAEDzB,OAAO,CAAC0B,GAAR,CAAY,IAAZ,EAAkBjB,MAAlB,EAA0BO,QAA1B,EAAoCE,MAApC;MAEA,OAAOA,MAAP;IACD,CAlCkB,CAAnB,CAHoD,CAuCpD;IACA;;IACA,IAAI,sBAAOT,MAAP,MAAkB,QAAlB,IAA8B,CAACA,MAAM,CAACkB,SAA1C,EAAqD;MACnDlB,MAAM,CAACC,IAAD,CAAN,GAAeC,UAAU,CAACE,KAA1B;IACD;;IAED,OAAOF,UAAP;EACD;AACF"}