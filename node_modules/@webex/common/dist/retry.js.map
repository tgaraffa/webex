{"version":3,"names":["retry","params","options","backoff","delay","maxAttempts","strategyOptions","initialDelay","maxDelay","length","retryDecorator","target","prop","descriptor","value","retryExecutor","fn","args","emitter","EventEmitter","promise","resolve","reject","call","cb","innerPromise","on","emit","bind","then","res","catch","reason","Error","err","setStrategy","ExponentialStrategy","failAfter","start","key","callback","prototype"],"sources":["retry.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {EventEmitter} from 'events';\n\nimport {defaults, isFunction, wrap} from 'lodash';\nimport backoff from 'backoff';\n\n/* eslint max-nested-callbacks: [0] */\n\n/**\n * Makes a promise-returning method retryable according to the specified backoff\n * pattern\n * @param {Object} options\n * @param {boolean} options.backoff\n * @param {number} options.delay\n * @param {number} options.initialDelay\n * @param {number} options.maxAttempts\n * @param {number} options.maxDelay\n *\n * @returns {Function}\n */\nexport default function retry(...params) {\n  let options = params[0] || {};\n\n  options = Object.assign({}, options);\n  defaults(options, {\n    backoff: true,\n    delay: 1,\n    maxAttempts: 3\n  });\n\n  let strategyOptions;\n\n  if (options.backoff) {\n    strategyOptions = {\n      initialDelay: options.delay,\n      maxDelay: options.maxDelay\n    };\n  }\n  else {\n    strategyOptions = {\n      initialDelay: 1,\n      maxDelay: 1\n    };\n  }\n\n  if (params.length === 3) {\n    return Reflect.apply(retryDecorator, null, params);\n  }\n\n  return retryDecorator;\n\n  /**\n   * @param {Object} target\n   * @param {string} prop\n   * @param {Object} descriptor\n   * @private\n   * @returns {Object}\n   */\n  function retryDecorator(target, prop, descriptor) {\n    descriptor.value = wrap(descriptor.value, function retryExecutor(fn, ...args) {\n      const emitter = new EventEmitter();\n      const promise = new Promise((resolve, reject) => {\n        // backoff.call is not Function.prototype.call; it's an unfortunate naming\n        // collision.\n        /* eslint prefer-reflect: [0] */\n        const call = backoff.call(\n          (cb) => {\n            /* eslint no-invalid-this: [0] */\n            const innerPromise = Reflect.apply(fn, this, args);\n\n            if (isFunction(innerPromise.on)) {\n              innerPromise.on('progress', emitter.emit.bind(emitter, 'progress'));\n              innerPromise.on('upload-progress', emitter.emit.bind(emitter, 'upload-progress'));\n              innerPromise.on('download-progress', emitter.emit.bind(emitter, 'download-progress'));\n            }\n\n            return innerPromise\n              .then((res) => {\n                cb(null, res);\n              })\n              .catch((reason) => {\n                if (!reason) {\n                  reason = new Error('retryable method failed without providing an error object');\n                }\n                cb(reason);\n              });\n          },\n          (err, res) => {\n            if (err) {\n              return reject(err);\n            }\n\n            return resolve(res);\n          }\n        );\n\n        call.setStrategy(new backoff.ExponentialStrategy(strategyOptions));\n        if (options.maxAttempts) {\n          call.failAfter(options.maxAttempts - 1);\n        }\n\n        call.start();\n      });\n\n      promise.on = function on(key, callback) {\n        emitter.on(key, callback);\n\n        return promise;\n      };\n\n      return promise;\n    });\n\n    // This *should* make decorators compatible with AmpersandState class\n    // definitions\n    if (typeof target === 'object' && !target.prototype) {\n      target[prop] = descriptor.value;\n    }\n\n    return descriptor;\n  }\n}\n"],"mappings":"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"}