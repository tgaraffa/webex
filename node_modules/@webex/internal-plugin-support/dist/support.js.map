{"version":3,"names":["Support","WebexPlugin","extend","namespace","getFeedbackUrl","options","request","method","api","resource","body","appVersion","config","appType","feedbackId","uuid","v4","languageCode","then","res","url","getSupportUrl","webex","qs","submitLogs","metadata","logs","metadataArray","_constructFileMetadata","logger","sdkBuffer","clientBuffer","buffer","formatLogs","filename","locusId","callStart","sessionId","userId","credentials","getUserToken","catch","getClientToken","token","headers","authorization","toString","initalOpts","service","finalOpts","file","shouldAttemptReauth","phases","initialize","upload","$uri","session","tempURL","finalize","$body","logFilename","data","internal","device","map","key","value","filter","entry","Boolean","push","orgId"],"sources":["support.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {WebexPlugin} from '@webex/webex-core';\nimport {defaults} from 'lodash';\nimport uuid from 'uuid';\n\nconst Support = WebexPlugin.extend({\n  namespace: 'Support',\n\n  getFeedbackUrl(options) {\n    options = options || {};\n\n    return this.request({\n      method: 'POST',\n      api: 'conversation',\n      resource: 'users/deskFeedbackUrl',\n      body: defaults(options, {\n        appVersion: this.config.appVersion,\n        appType: this.config.appType,\n        feedbackId: options.feedbackId || uuid.v4(),\n        languageCode: this.config.languageCode\n      })\n    })\n      .then((res) => res.body.url);\n  },\n\n  getSupportUrl() {\n    return this.webex.request({\n      method: 'GET',\n      api: 'conversation',\n      resource: 'users/deskSupportUrl',\n      qs: {\n        languageCode: this.config.languageCode\n      }\n    })\n      .then((res) => res.body.url);\n  },\n\n  submitLogs(metadata, logs) {\n    const metadataArray = this._constructFileMetadata(metadata);\n\n    // this is really testing that Ampersand is fully ready.  once it's ready, these exist\n    if (!logs && this.webex.logger.sdkBuffer && this.webex.logger.clientBuffer && this.webex.logger.buffer) {\n      logs = this.webex.logger.formatLogs();\n    }\n\n    let filename;\n\n    if (metadata.locusId && metadata.callStart) {\n      filename = `${metadata.locusId}_${metadata.callStart}.txt`;\n    }\n    else {\n      filename = `${this.webex.sessionId}.txt`;\n    }\n\n    let userId;\n\n    return this.webex.credentials.getUserToken()\n      .catch(() => this.webex.credentials.getClientToken())\n      .then(async (token) => {\n        const headers = {authorization: token.toString()};\n\n        const initalOpts = {\n          service: 'clientLogs',\n          resource: 'logs/urls'\n        };\n\n        const finalOpts = {\n          service: 'clientLogs',\n          resource: 'logs/meta'\n        };\n\n        const options = defaults(initalOpts, {\n          file: logs,\n          shouldAttemptReauth: false,\n          headers,\n          phases: {\n            initialize: {\n              body: {\n                file: filename\n              }\n            },\n            upload: {\n              $uri: (session) => session.tempURL\n            },\n            finalize: defaults(finalOpts, {\n              $body: (session) => {\n                userId = session.userId;\n\n                return {\n                  filename: session.logFilename,\n                  data: metadataArray,\n                  userId: this.webex.internal.device.userId || session.userId\n                };\n              }\n            })\n          }\n        });\n\n        return this.webex.upload(options);\n      })\n      .then((body) => {\n        if (userId && !body.userId) {\n          body.userId = userId;\n        }\n\n        return body;\n      });\n  },\n\n  _constructFileMetadata(metadata) {\n    const metadataArray = [\n      'locusId',\n      'callStart',\n      'feedbackId',\n      'correlationId',\n      'meetingId'\n    ].map((key) => {\n      if (metadata[key]) {\n        return {\n          key,\n          value: metadata[key]\n        };\n      }\n\n      return null;\n    })\n      .filter((entry) => Boolean(entry));\n\n    if (this.webex.sessionId) {\n      metadataArray.push({\n        key: 'trackingId',\n        value: this.webex.sessionId\n      });\n    }\n\n    if (this.webex.internal.device.userId) {\n      metadataArray.push({\n        key: 'userId',\n        value: this.webex.internal.device.userId\n      });\n    }\n\n    if (this.webex.internal.device.orgId) {\n      metadataArray.push({\n        key: 'orgId',\n        value: this.webex.internal.device.orgId\n      });\n    }\n\n    return metadataArray;\n  }\n});\n\nexport default Support;\n"],"mappings":"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"}