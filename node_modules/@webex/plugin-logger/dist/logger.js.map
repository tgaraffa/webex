{"version":3,"names":["precedence","silent","group","groupEnd","error","warn","log","info","debug","trace","levels","filter","level","fallbacks","LOG_TYPES","SDK","CLIENT","SDK_LOG_TYPE_NAME","authTokenKeyPattern","walkAndFilter","object","visited","includes","push","map","o","patterns","containsEmails","test","replace","key","value","Logger","WebexPlugin","extend","namespace","derived","cache","fn","getCurrentLevel","client_level","getCurrentClientLevel","session","buffer","type","default","groupLevel","sdkBuffer","clientBuffer","args","arg","Error","process","env","NODE_ENV","inBrowser","ret","toString","stack","shouldPrint","shouldBuffer","config","bufferLogLevel","WEBEX_LOG_LEVEL","webex","internal","device","features","developer","get","clientLevel","formatLogs","getDate","clientIndex","sdkIndex","separateLogBuffers","length","Date","join","makeLoggerMethod","impl","neverPrint","alwaysBuffer","wrappedConsoleMethod","logType","clientName","historyLength","clientHistoryLength","filtered","stringified","item","WebexHttpError","toPrint","unshift","url","slice","console","logDate","toISOString","repeat","shift","reason","forEach","impls","pop","prototype","client_logToBuffer","logToBuffer"],"sources":["logger.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {inBrowser, patterns} from '@webex/common';\nimport {\n  WebexHttpError,\n  WebexPlugin\n} from '@webex/webex-core';\nimport {\n  cloneDeep,\n  has,\n  isArray,\n  isObject,\n  isString\n} from 'lodash';\n\nconst precedence = {\n  silent: 0,\n  group: 1,\n  groupEnd: 2,\n  error: 3,\n  warn: 4,\n  log: 5,\n  info: 6,\n  debug: 7,\n  trace: 8\n};\n\nexport const levels = Object.keys(precedence).filter((level) => level !== 'silent');\n\nconst fallbacks = {\n  error: ['log'],\n  warn: ['error', 'log'],\n  info: ['log'],\n  debug: ['info', 'log'],\n  trace: ['debug', 'info', 'log']\n};\n\nconst LOG_TYPES = {\n  SDK: 'sdk',\n  CLIENT: 'client'\n};\n\nconst SDK_LOG_TYPE_NAME = 'wx-js-sdk';\n\nconst authTokenKeyPattern = /[Aa]uthorization/;\n\n/**\n * Recursively strips \"authorization\" fields from the specified object\n * @param {Object} object\n * @param {Array<mixed>} [visited]\n * @private\n * @returns {Object}\n */\nfunction walkAndFilter(object, visited = []) {\n  if (visited.includes(object)) {\n    // Prevent circular references\n    return object;\n  }\n\n  visited.push(object);\n\n  if (isArray(object)) {\n    return object.map((o) => walkAndFilter(o, visited));\n  }\n  if (!isObject(object)) {\n    if (isString(object)) {\n      if (patterns.containsEmails.test(object)) {\n        return object.replace(patterns.containsEmails, '[REDACTED]');\n      }\n    }\n\n    return object;\n  }\n\n  for (const [key, value] of Object.entries(object)) {\n    if (authTokenKeyPattern.test(key)) {\n      Reflect.deleteProperty(object, key);\n    }\n    else {\n      object[key] = walkAndFilter(value, visited);\n    }\n  }\n\n  return object;\n}\n\n/**\n * @class\n */\nconst Logger = WebexPlugin.extend({\n  namespace: 'Logger',\n\n  derived: {\n    level: {\n      cache: false,\n      fn() {\n        return this.getCurrentLevel();\n      }\n    },\n    client_level: {\n      cache: false,\n      fn() {\n        return this.getCurrentClientLevel();\n      }\n    }\n  },\n  session: {\n    // for when configured to use single buffer\n    buffer: {\n      type: 'array',\n      default() {\n        return [];\n      }\n    },\n    groupLevel: {\n      type: 'number',\n      default() {\n        return 0;\n      }\n    },\n    // for when configured to use separate buffers\n    sdkBuffer: {\n      type: 'array',\n      default() {\n        return [];\n      }\n    },\n    clientBuffer: {\n      type: 'array',\n      default() {\n        return [];\n      }\n    }\n  },\n\n  /**\n   * Ensures auth headers don't get printed in logs\n   * @param {Array<mixed>} args\n   * @private\n   * @memberof Logger\n   * @returns {Array<mixed>}\n   */\n  filter(...args) {\n    return args.map((arg) => {\n      // WebexHttpError already ensures auth tokens don't get printed, so, no\n      // need to alter it here.\n      if (arg instanceof Error) {\n        // karma logs won't print subclassed errors correctly, so we need\n        // explicitly call their tostring methods.\n        if (process.env.NODE_ENV === 'test' && inBrowser) {\n          let ret = arg.toString();\n\n          ret += 'BEGIN STACK';\n          ret += arg.stack;\n          ret += 'END STACK';\n\n          return ret;\n        }\n\n        return arg;\n      }\n\n      arg = cloneDeep(arg);\n\n      return walkAndFilter(arg);\n    });\n  },\n\n  /**\n   * Determines if the current level allows logs at the specified level to be\n   * printed\n   * @param {string} level\n   * @param {string} type type of log, SDK or client\n   * @private\n   * @memberof Logger\n   * @returns {boolean}\n   */\n  shouldPrint(level, type = LOG_TYPES.SDK) {\n    return precedence[level] <= precedence[type === LOG_TYPES.SDK ? this.getCurrentLevel() : this.getCurrentClientLevel()];\n  },\n\n  /**\n   * Determines if the current level allows logs at the specified level to be\n   * put into the log buffer. We're configuring it omit trace and debug logs\n   * because there are *a lot* of debug logs that really don't provide value at\n   * runtime (they're helpful for debugging locally, but really just pollute the\n   * uploaded logs and push useful info out).\n   * @param {string} level\n   * @param {string} type type of log, SDK or client\n   * @private\n   * @memberof Logger\n   * @returns {boolean}\n   */\n  shouldBuffer(level) {\n    return precedence[level] <= (this.config.bufferLogLevel ? precedence[this.config.bufferLogLevel] : precedence.info);\n  },\n\n  /**\n   * Indicates the current SDK log level based on env vars, feature toggles, and\n   * user type.\n   * @instance\n   * @memberof Logger\n   * @private\n   * @memberof Logger\n   * @returns {string}\n   */\n  // eslint-disable-next-line complexity\n  getCurrentLevel() {\n    // If a level has been explicitly set via config, alway use it.\n    if (this.config.level) {\n      return this.config.level;\n    }\n\n    if (levels.includes(process.env.WEBEX_LOG_LEVEL)) {\n      return process.env.WEBEX_LOG_LEVEL;\n    }\n\n    // Always use debug-level logging in test mode;\n    if (process.env.NODE_ENV === 'test') {\n      return 'trace';\n    }\n\n    // Use server-side-feature toggles to configure log levels\n    const level = this.webex.internal.device && this.webex.internal.device.features.developer.get('log-level');\n\n    if (level) {\n      if (levels.includes(level)) {\n        return level;\n      }\n    }\n\n    return 'error';\n  },\n\n  /**\n   * Indicates the current client log level based on config, defaults to SDK level\n   * @instance\n   * @memberof Logger\n   * @private\n   * @memberof Logger\n   * @returns {string}\n   */\n  getCurrentClientLevel() {\n    // If a client log level has been explicitly set via config, alway use it.\n    if (this.config.clientLevel) {\n      return this.config.clientLevel;\n    }\n\n    // otherwise default to SDK level\n    return this.getCurrentLevel();\n  },\n\n  /**\n   * Format logs (for upload)\n   *\n   * If separate client, SDK buffers is configured, merge the buffers, if configured\n   *\n   * @instance\n   * @memberof Logger\n   * @public\n   * @memberof Logger\n   * @returns {string} formatted buffer\n   */\n  formatLogs() {\n    function getDate(log) {\n      return log[1];\n    }\n    let buffer = [];\n    let clientIndex = 0;\n    let sdkIndex = 0;\n\n    if (this.config.separateLogBuffers) {\n      // merge the client and sdk buffers\n      // while we have entries in either buffer\n      while (clientIndex < this.clientBuffer.length || sdkIndex < this.sdkBuffer.length) {\n      // if we have remaining entries in the SDK buffer\n        if (sdkIndex < this.sdkBuffer.length &&\n          // and we haven't exhausted all the client buffer entries, or SDK date is before client date\n          (clientIndex >= this.clientBuffer.length ||\n            (new Date(getDate(this.sdkBuffer[sdkIndex])) <= new Date(getDate(this.clientBuffer[clientIndex]))))) {\n          // then add to the SDK buffer\n          buffer.push(this.sdkBuffer[sdkIndex]);\n          sdkIndex += 1;\n        }\n        // otherwise if we haven't exhausted all the client buffer entries, add client entry, whether it was because\n        // it was the only remaining entries or date was later (the above if)\n        else if (clientIndex < this.clientBuffer.length) {\n          buffer.push(this.clientBuffer[clientIndex]);\n          clientIndex += 1;\n        }\n      }\n    }\n    else {\n      buffer = this.buffer;\n    }\n\n    return buffer.join('\\n');\n  }\n});\n\n/**\n * Creates a logger method\n *\n *\n * @param {string} level level to create (info, error, warn, etc.)\n * @param {string} impl the level to use when writing to console\n * @param {string} type type of log, SDK or client\n * @param {bool} neverPrint function never prints to console\n * @param {bool} alwaysBuffer function always logs to log buffer\n * @instance\n * @memberof Logger\n * @private\n * @memberof Logger\n * @returns {function} logger method with specified params\n */\nfunction makeLoggerMethod(level, impl, type, neverPrint = false, alwaysBuffer = false) {\n  // Much of the complexity in the following function is due to a test-mode-only\n  // helper\n  return function wrappedConsoleMethod(...args) {\n    // it would be easier to just pass in the name and buffer here, but the config isn't completely initialized\n    // in Ampersand, even if the initialize method is used to set this up.  so we keep the type to achieve\n    // a sort of late binding to allow retrieving a name from config.\n    const logType = type;\n    const clientName = logType === LOG_TYPES.SDK ? SDK_LOG_TYPE_NAME : (this.config.clientName || logType);\n\n    let buffer;\n    let historyLength;\n\n    if (this.config.separateLogBuffers) {\n      historyLength = this.config.clientHistoryLength ? this.config.clientHistoryLength : this.config.historyLength;\n      buffer = logType === LOG_TYPES.SDK ? this.sdkBuffer : this.clientBuffer;\n    }\n    else {\n      buffer = this.buffer;\n      historyLength = this.config.historyLength;\n    }\n\n    try {\n      const shouldPrint = !neverPrint && this.shouldPrint(level, logType);\n      const shouldBuffer = alwaysBuffer || this.shouldBuffer(level);\n\n      if (!shouldBuffer && !shouldPrint) {\n        return;\n      }\n\n      const filtered = [clientName, ...this.filter(...args)];\n      const stringified = filtered.map((item) => {\n        if (item instanceof WebexHttpError) {\n          return item.toString();\n        }\n\n        return item;\n      });\n\n      if (shouldPrint) {\n        // when logging an object in browsers, we tend to get a dynamic\n        // reference, thus going back to look at the logged value doesn't\n        // necessarily show the state at log time, thus we print the stringified\n        // value.\n        const toPrint = inBrowser ? stringified : filtered;\n\n        /* istanbul ignore if */\n        if (process.env.NODE_ENV === 'test' && has(this, 'webex.internal.device.url')) {\n          toPrint.unshift(this.webex.internal.device.url.slice(-3));\n        }\n        // eslint-disable-next-line no-console\n        console[impl](...toPrint);\n      }\n\n      if (shouldBuffer) {\n        const logDate = new Date();\n\n        stringified.unshift(logDate.toISOString());\n        stringified.unshift('|  '.repeat(this.groupLevel));\n        buffer.push(stringified);\n        if (buffer.length > historyLength) {\n          buffer.shift();\n        }\n        if (level === 'group') this.groupLevel += 1;\n        if (level === 'groupEnd' && this.groupLevel > 0) this.groupLevel -= 1;\n      }\n    }\n    catch (reason) {\n      if (!neverPrint) {\n        /* istanbul ignore next */\n        // eslint-disable-next-line no-console\n        console.warn(`failed to execute Logger#${level}`, reason);\n      }\n    }\n  };\n}\n\nlevels.forEach((level) => {\n  let impls = fallbacks[level];\n  let impl = level;\n\n  if (impls) {\n    impls = impls.slice();\n    // eslint-disable-next-line no-console\n    while (!console[impl]) {\n      impl = impls.pop();\n    }\n  }\n\n\n  // eslint-disable-next-line complexity\n  Logger.prototype[`client_${level}`] = makeLoggerMethod(level, impl, LOG_TYPES.CLIENT);\n  Logger.prototype[level] = makeLoggerMethod(level, impl, LOG_TYPES.SDK);\n});\n\nLogger.prototype.client_logToBuffer =\n  makeLoggerMethod(levels.info, levels.info, LOG_TYPES.CLIENT, true, true);\nLogger.prototype.logToBuffer = makeLoggerMethod(levels.info, levels.info, LOG_TYPES.SDK, true, true);\n\nexport default Logger;\n"],"mappings":"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"}