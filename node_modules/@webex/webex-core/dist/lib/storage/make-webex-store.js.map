{"version":3,"names":["bindings","makeWebexStore","type","webex","WebexStore","oneFlight","keyFactory","namespace","logger","debug","set","config","storage","get","promises","forEach","binding","push","clear","all","key","_getBinding","then","del","value","put","serialize","resolve","adapter","bind","_binding","prototype","Events"],"sources":["make-webex-store.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport Events from 'ampersand-events';\nimport {oneFlight} from '@webex/common';\n\nconst bindings = new WeakMap();\n\n/**\n * Makes a WebexStore for the specified type bound to the specified webex instance\n * @param {string} type\n * @param {ProxyWebex} webex\n * @private\n * @returns {WebexStore}\n */\nexport default function makeWebexStore(type, webex) {\n  /**\n   * Lazy Key-Value Store Interface\n   */\n  class WebexStore {\n    /**\n     * @param {Object} attrs\n     * @param {Object} options\n     * @returns {Store}\n     */\n    constructor() {\n      webex.logger.debug(`webex-store: constructing ${type}Storage`);\n      bindings.set(this, new Map());\n    }\n\n    /**\n     * Provides easy access to the storage adapter identified in config.\n     * @returns {Object}\n     */\n    get adapter() {\n      return webex.config.storage[`${type}Adapter`];\n    }\n\n    /**\n     * @returns {WeakMap}\n     */\n    get bindings() {\n      return bindings.get(this);\n    }\n\n    /**\n     * Clears the store\n     * @returns {Promise}\n     */\n    clear() {\n      const promises = [];\n\n      this.bindings.forEach((binding) => {\n        promises.push(binding.clear());\n      });\n\n      return Promise.all(promises);\n    }\n\n    /**\n     * Deletes the specified key from the store\n     * @param {string} namespace\n     * @param {string} key\n     * @returns {[type]}\n     */\n    del(namespace, key) {\n      webex.logger.debug(`webex-store: removing ${namespace}:${key}`);\n\n      return this._getBinding(namespace)\n        .then((binding) => binding.del(key));\n    }\n\n    /**\n     * Retrieves the value specified by key from the store. Rejects with\n     * NotFoundError if no value can be found\n     * @param {string} namespace\n     * @param {string} key\n     * @returns {Promise}\n     */\n    get(namespace, key) {\n      webex.logger.debug(`webex-store: retrieving ${namespace}:${key}`);\n\n      return this._getBinding(namespace)\n        .then((binding) => binding.get(key));\n    }\n\n    /**\n     * Writes a value to the store. Deletes the specified key from the store\n     * if passed `undefined`\n     * @param {string} namespace\n     * @param {string} key\n     * @param {any} value\n     * @returns {Promise} Resolves with value (to simplify write-through caching)\n     */\n    put(namespace, key, value) {\n      if (typeof value === 'undefined') {\n        return this.del(namespace, key);\n      }\n      webex.logger.debug(`webex-store: setting ${namespace}:${key}`);\n\n      return this._getBinding(namespace)\n        .then((binding) => binding.put(key, value.serialize ? value.serialize() : value))\n        .then(() => value);\n    }\n\n    @oneFlight({keyFactory: (namespace) => namespace})\n    /**\n     * Creates an interface bound to the specified namespace\n     * @param {string} namespace\n     * @private\n     * @returns {Promise}\n     */\n    // suppress doc warning because decorators confuse eslint\n    // eslint-disable-next-line require-jsdoc\n    _getBinding(namespace) {\n      return new Promise((resolve) => {\n        webex.logger.debug(`storage: getting binding for \\`${namespace}\\``);\n        const binding = this.bindings.get(namespace);\n\n        if (binding) {\n          webex.logger.debug(`storage: found binding for \\`${namespace}\\``);\n\n          return resolve(binding);\n        }\n\n        return resolve(this.adapter.bind(namespace, {logger: webex.logger})\n          .then((_binding) => {\n            webex.logger.debug(`storage: made binding for \\`${namespace}\\``);\n            this.bindings.set(namespace, _binding);\n\n            return _binding;\n          }));\n      });\n    }\n  }\n\n  Object.assign(WebexStore.prototype, Events);\n\n  return new WebexStore();\n}\n"],"mappings":"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"}