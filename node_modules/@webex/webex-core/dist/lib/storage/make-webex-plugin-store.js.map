{"version":3,"names":["defers","serialize","value","serialized","forEach","key","val","length","undefined","map","k","empty","reduce","acc","makeWebexPluginStorage","type","context","WebexPluginStorage","oneFlight","keyFactory","set","webex","del","getNamespace","args","defer","get","Defer","then","res","resolve","put","logger","debug","promise","initValue","parent","catch","reason","NotFoundError","process","env","NODE_ENV","toString","includes","warn","reject"],"sources":["make-webex-plugin-store.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {Defer, oneFlight} from '@webex/common';\nimport {isArray, isObject, result} from 'lodash';\n\nimport {NotFoundError} from './errors';\n\nconst defers = new WeakMap();\n\n/**\n * Walks an object before writing it to the store and omits empty arrays\n * @private\n * @param {Object} value\n * @returns {Object}\n */\nfunction serialize(value) {\n  if (!isObject(value)) {\n    return value;\n  }\n\n  const serialized = value.serialize ? value.serialize() : value;\n\n  Object.keys(serialized).forEach((key) => {\n    const val = serialized[key];\n\n    if (isArray(val)) {\n      if (val.length === 0) {\n        serialized[key] = undefined;\n      }\n      else {\n        serialized[key] = val.map(serialize);\n      }\n    }\n    else if (isObject(val)) {\n      Object.keys(val).forEach((k) => {\n        val[k] = serialize(val[k]);\n      });\n    }\n  });\n\n  const empty = Object.keys(serialized).reduce((acc, key) => acc && !serialized[key], true);\n\n  if (empty) {\n    return undefined;\n  }\n\n  return serialized;\n}\n\n/**\n * [makeWebexPluginStorage description]\n * @param {[type]} type\n * @param {[type]} context\n * @private\n * @returns {[type]}\n */\nexport default function makeWebexPluginStorage(type, context) {\n  /**\n   * Interface between WebexPlugin and Webex#boundeStorage or\n   * Webex#unboundedStorage\n   */\n  class WebexPluginStorage {\n    /**\n     * @param {Object} attrs\n     * @param {Object} options\n     * @returns {WebexPluginStorage}\n     */\n    constructor() {\n      defers.set(this, new Map());\n    }\n\n    /**\n     * Clears an entire namespace\n     * @returns {Promise}\n     */\n    clear() {\n      return context.webex[`${type}Storage`].del(context.getNamespace());\n    }\n\n    /**\n     * Deletes the specified key from the store\n     * @param {string} key\n     * @returns {[type]}\n     */\n    del(...args) {\n      return context.webex[`${type}Storage`].del(context.getNamespace(), ...args);\n    }\n\n    /**\n     * Retrieves the value specified by key from the store. Rejects with\n     * NotFoundError if no value can be found\n     * @param {string} key\n     * @returns {Promise}\n     */\n    get(key) {\n      let defer = defers.get(this).get(key);\n\n      if (!defer) {\n        defer = new Defer();\n        defers.get(this).set(key, defer);\n      }\n\n      return context.webex[`${type}Storage`].get(context.getNamespace(), key)\n        .then((res) => {\n          defer.resolve();\n\n          return res;\n        });\n    }\n\n    /**\n     * Writes a value to the store\n     * @param {string} key\n     * @param {any} value\n     * @returns {Promise}\n     */\n    put(key, value) {\n      return context.webex[`${type}Storage`].put(context.getNamespace(), key, serialize(value));\n    }\n\n    /**\n     * Returns a Promise that won't resolve until the value specified by key has\n     * been attempted to be loaded from the store. This allows us to lazily\n     * prevent certain method from executing until the specified keys have been\n     * retrieved from the store.\n     * @param {string} key\n     * @returns {Promise}\n     */\n    waitFor(key) {\n      context.logger.debug(`plugin-storage(${context.getNamespace()}): waiting to init key \\`${key}\\``);\n      const defer = defers.get(this).get(key);\n\n      if (defer) {\n        context.logger.debug(`plugin-storage(${context.getNamespace()}): already inited \\`${key}\\``);\n\n        return defer.promise;\n      }\n\n      context.logger.debug(`plugin-storage(${context.getNamespace()}): initing \\`${key}\\``);\n\n      return this.initValue(key);\n    }\n\n    @oneFlight({keyFactory: (key) => `initValue-${key}`})\n    /**\n     * Attempts to load the specified key from the store and set it on the parent\n     * object.\n     * @param {string} key\n     * @returns {Promise} Resolves (but not with the retrieved value) when\n     * the value retrieval complete\n     */\n    // suppress doc warning because decorators confuse eslint\n    // eslint-disable-next-line require-jsdoc\n    initValue(key) {\n      const defer = new Defer();\n\n      defers.get(this).set(key, defer);\n\n      // Intentionally bypasses this.get so we don't resolve the promise until\n      // after the parent value is set.\n      context.webex[`${type}Storage`].get(context.getNamespace(), key)\n        .then((value) => {\n          context.logger.debug(`plugin-storage(${context.getNamespace()}): got \\`${key}\\` for first time`);\n          if (key === '@') {\n            context.parent.set(value);\n          }\n          else if (result(context[key], 'isState')) {\n            context[key].set(value);\n          }\n          else {\n            context.set(key, value);\n          }\n          context.logger.debug(`plugin-storage(${context.getNamespace()}): set \\`${key}\\` for first time`);\n          defer.resolve();\n          context.logger.debug(`plugin-storage(${context.getNamespace()}): inited \\`${key}\\``);\n        })\n        .catch((reason) => {\n          // The  next conditional is a bit of an unfortunate solution to deal\n          // with circular dependencies in unit tests. It should not effect\n          // integration tests or production code.\n          if (reason instanceof NotFoundError || process.env.NODE_ENV !== 'production' && reason.toString().includes('MockNotFoundError')) {\n            context.logger.debug(`plugin-storage(${context.getNamespace()}): no data for \\`${key}\\`, continuing`);\n\n            return defer.resolve();\n          }\n          context.logger.warn(`plugin-storage(${context.getNamespace()}): failed to init \\`${key}\\``, reason);\n\n          return defer.reject(reason);\n        });\n\n      return defer.promise;\n    }\n  }\n\n  return new WebexPluginStorage();\n}\n"],"mappings":"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"}