{"version":3,"names":["ServiceCatalog","AmpState","extend","namespace","props","serviceGroups","discovery","override","preauth","postauth","signin","status","ready","collecting","isReady","allowedDomains","_getUrl","name","serviceGroup","serviceUrls","find","serviceUrl","_listServiceUrls","_loadServiceUrls","services","existingService","forEach","service","push","_unloadServiceUrls","splice","indexOf","clean","length","findClusterId","url","incomingUrlObj","Url","parse","serviceUrlObj","key","defaultUrl","hosts","host","hostname","id","homeCluster","undefined","findServiceFromClusterId","clusterId","priorityHost","identifiedServiceUrl","get","findServiceUrlFromUrl","findAllowedDomain","urlObj","allowedDomain","includes","getAllowedDomains","list","output","markFailedUrl","noPriorityHosts","failHost","setAllowedDomains","updateServiceUrls","serviceHostmap","currentServiceUrls","unusedUrls","filter","every","item","serviceObj","ServiceUrl","trigger","waitForCatalog","timeout","resolve","reject","timeoutTimer","setTimeout","Error","once","clearTimeout"],"sources":["service-catalog.js"],"sourcesContent":["import Url from 'url';\n\nimport AmpState from 'ampersand-state';\n\nimport ServiceUrl from './service-url';\n\n/* eslint-disable no-underscore-dangle */\n/**\n * @class\n */\nconst ServiceCatalog = AmpState.extend({\n  namespace: 'ServiceCatalog',\n\n  props: {\n    serviceGroups: ['object', true, (() => ({\n      discovery: [],\n      override: [],\n      preauth: [],\n      postauth: [],\n      signin: []\n    }))],\n    status: ['object', true, (() => ({\n      discovery: {\n        ready: false,\n        collecting: false\n      },\n      override: {\n        ready: false,\n        collecting: false\n      },\n      preauth: {\n        ready: false,\n        collecting: false\n      },\n      postauth: {\n        ready: false,\n        collecting: false\n      },\n      signin: {\n        ready: false,\n        collecting: false\n      }\n    }))],\n    isReady: ['boolean', false, false],\n    allowedDomains: ['array', false, (() => [])]\n  },\n\n  /**\n   * @private\n   * Search the service url array to locate a `ServiceUrl`\n   * class object based on its name.\n   * @param {string} name\n   * @param {string} [serviceGroup]\n   * @returns {ServiceUrl}\n   */\n  _getUrl(name, serviceGroup) {\n    const serviceUrls = (typeof serviceGroup === 'string') ?\n      this.serviceGroups[serviceGroup] || [] :\n      [\n        ...this.serviceGroups.override,\n        ...this.serviceGroups.postauth,\n        ...this.serviceGroups.signin,\n        ...this.serviceGroups.preauth,\n        ...this.serviceGroups.discovery\n      ];\n\n    return serviceUrls.find((serviceUrl) => serviceUrl.name === name);\n  },\n\n  /**\n   * @private\n   * Generate an array of `ServiceUrl`s that is organized from highest auth\n   * level to lowest auth level.\n   * @returns {Array<ServiceUrl>} - array of `ServiceUrl`s\n   */\n  _listServiceUrls() {\n    return [\n      ...this.serviceGroups.override,\n      ...this.serviceGroups.postauth,\n      ...this.serviceGroups.signin,\n      ...this.serviceGroups.preauth,\n      ...this.serviceGroups.discovery\n    ];\n  },\n\n  /**\n   * @private\n   * Safely load one or more `ServiceUrl`s into this `Services` instance.\n   * @param {string} serviceGroup\n   * @param  {Array<ServiceUrl>} services\n   * @returns {Services}\n   */\n  _loadServiceUrls(serviceGroup, services) {\n    // declare namespaces outside of loop\n    let existingService;\n\n    services.forEach((service) => {\n      existingService = this._getUrl(service.name, serviceGroup);\n\n      if (!existingService) {\n        this.serviceGroups[serviceGroup].push(service);\n      }\n    });\n\n    return this;\n  },\n\n  /**\n   * @private\n   * Safely unload one or more `ServiceUrl`s into this `Services` instance\n   * @param {string} serviceGroup\n   * @param  {Array<ServiceUrl>} services\n   * @returns {Services}\n   */\n  _unloadServiceUrls(serviceGroup, services) {\n    // declare namespaces outside of loop\n    let existingService;\n\n    services.forEach((service) => {\n      existingService = this._getUrl(service.name, serviceGroup);\n\n      if (existingService) {\n        this.serviceGroups[serviceGroup].splice(\n          this.serviceGroups[serviceGroup].indexOf(existingService), 1\n        );\n      }\n    });\n\n    return this;\n  },\n\n  /**\n   * Clear all collected catalog data and reset catalog status.\n   *\n   * @returns {void}\n   */\n  clean() {\n    this.serviceGroups.preauth.length = 0;\n    this.serviceGroups.signin.length = 0;\n    this.serviceGroups.postauth.length = 0;\n    this.status.preauth = {ready: false};\n    this.status.signin = {ready: false};\n    this.status.postauth = {ready: false};\n  },\n\n  /**\n   * Search over all service groups to find a cluster id based\n   * on a given url.\n   * @param {string} url - Must be parsable by `Url`\n   * @returns {string} - ClusterId of a given url\n   */\n  findClusterId(url) {\n    const incomingUrlObj = Url.parse(url);\n    let serviceUrlObj;\n\n    for (const key of Object.keys(this.serviceGroups)) {\n      for (const service of this.serviceGroups[key]) {\n        serviceUrlObj = Url.parse(service.defaultUrl);\n\n        for (const host of service.hosts) {\n          if (incomingUrlObj.hostname === host.host && host.id) {\n            return host.id;\n          }\n        }\n\n        if (serviceUrlObj.hostname === incomingUrlObj.hostname &&\n          service.hosts.length > 0) {\n          // no exact match, so try to grab the first home cluster\n          for (const host of service.hosts) {\n            if (host.homeCluster) {\n              return host.id;\n            }\n          }\n\n          // no match found still, so return the first entry\n          return service.hosts[0].id;\n        }\n      }\n    }\n\n    return undefined;\n  },\n\n  /**\n   * Search over all service groups and return a service value from a provided\n   * clusterId. Currently, this method will return either a service name, or a\n   * service url depending on the `value` parameter. If the `value` parameter\n   * is set to `name`, it will return a service name to be utilized within the\n   * Services plugin methods.\n   * @param {object} params\n   * @param {string} params.clusterId - clusterId of found service\n   * @param {boolean} [params.priorityHost = true] - returns priority host url if true\n   * @param {string} [params.serviceGroup] - specify service group\n   * @returns {object} service\n   * @returns {string} service.name\n   * @returns {string} service.url\n   */\n  findServiceFromClusterId({clusterId, priorityHost = true, serviceGroup} = {}) {\n    const serviceUrls = (typeof serviceGroup === 'string') ?\n      this.serviceGroups[serviceGroup] || [] : [\n        ...this.serviceGroups.override,\n        ...this.serviceGroups.postauth,\n        ...this.serviceGroups.signin,\n        ...this.serviceGroups.preauth,\n        ...this.serviceGroups.discovery\n      ];\n\n    const identifiedServiceUrl = serviceUrls.find(\n      (serviceUrl) => serviceUrl.hosts.find(\n        (host) => host.id === clusterId\n      )\n    );\n\n    if (identifiedServiceUrl) {\n      return {\n        name: identifiedServiceUrl.name,\n        url: identifiedServiceUrl.get(priorityHost, clusterId)\n      };\n    }\n\n    return undefined;\n  },\n\n  /**\n   * Find a service based on the provided url.\n   * @param {string} url - Must be parsable by `Url`\n   * @returns {serviceUrl} - ServiceUrl assocated with provided url\n   */\n  findServiceUrlFromUrl(url) {\n    const incomingUrlObj = Url.parse(url);\n    const serviceUrls = [\n      ...this.serviceGroups.discovery,\n      ...this.serviceGroups.preauth,\n      ...this.serviceGroups.signin,\n      ...this.serviceGroups.postauth,\n      ...this.serviceGroups.override\n    ];\n\n    return serviceUrls.find(\n      (serviceUrl) => {\n        if (incomingUrlObj.hostname ===\n          Url.parse(serviceUrl.defaultUrl).hostname) {\n          return true;\n        }\n\n        if (serviceUrl.hosts.find((host) => host.host === incomingUrlObj.hostname)) {\n          return true;\n        }\n\n        return false;\n      }\n    );\n  },\n\n  /**\n   * Finds an allowed domain that matches a specific url.\n   *\n   * @param {string} url - The url to match the allowed domains against.\n   * @returns {string} - The matching allowed domain.\n   */\n  findAllowedDomain(url) {\n    const urlObj = Url.parse(url);\n\n    if (!urlObj.host) {\n      return undefined;\n    }\n\n    return this.allowedDomains.find(\n      (allowedDomain) => urlObj.host.includes(allowedDomain)\n    );\n  },\n\n  /**\n   * Get a service url from the current services list by name.\n   * @param {string} name\n   * @param {boolean} priorityHost\n   * @param {string} serviceGroup\n   * @returns {string}\n   */\n  get(name, priorityHost, serviceGroup) {\n    const serviceUrl = this._getUrl(name, serviceGroup);\n\n    return (serviceUrl) ? serviceUrl.get(priorityHost) : undefined;\n  },\n\n  /**\n   * Get the current allowed domains list.\n   *\n   * @returns {Array<string>} - the current allowed domains list.\n   */\n  getAllowedDomains() {\n    return [...this.allowedDomains];\n  },\n\n  /**\n   * Creates an object where the keys are the service names\n   * and the values are the service urls.\n   * @param {boolean} priorityHost - use the highest priority if set to `true`\n   * @param {string} [serviceGroup]\n   * @returns {Record<string, string>}\n   */\n  list(priorityHost, serviceGroup) {\n    const output = {};\n\n    const serviceUrls = (typeof serviceGroup === 'string') ?\n      this.serviceGroups[serviceGroup] || [] :\n      [\n        ...this.serviceGroups.discovery,\n        ...this.serviceGroups.preauth,\n        ...this.serviceGroups.signin,\n        ...this.serviceGroups.postauth,\n        ...this.serviceGroups.override\n      ];\n\n    if (serviceUrls) {\n      serviceUrls.forEach((serviceUrl) => {\n        output[serviceUrl.name] = serviceUrl.get(priorityHost);\n      });\n    }\n\n    return output;\n  },\n\n  /**\n   * Mark a priority host service url as failed.\n   * This will mark the host associated with the\n   * `ServiceUrl` to be removed from the its\n   * respective host array, and then return the next\n   * viable host from the `ServiceUrls` host array,\n   * or the `ServiceUrls` default url if no other priority\n   * hosts are available, or if `noPriorityHosts` is set to\n   * `true`.\n   * @param {string} url\n   * @param {boolean} noPriorityHosts\n   * @returns {string}\n   */\n  markFailedUrl(url, noPriorityHosts) {\n    const serviceUrl = this._getUrl(Object.keys(this.list()).find(\n      (key) => this._getUrl(key).failHost(url)\n    ));\n\n    if (!serviceUrl) {\n      return undefined;\n    }\n\n    return (noPriorityHosts) ? serviceUrl.get(false) : serviceUrl.get(true);\n  },\n\n  /**\n   * Set the allowed domains for the catalog.\n   *\n   * @param {Array<string>} allowedDomains - allowed domains to be assigned.\n   * @returns {void}\n   */\n  setAllowedDomains(allowedDomains) {\n    this.allowedDomains = [...allowedDomains];\n  },\n\n  /**\n   * Update the current list of `ServiceUrl`s against a provided\n   * service hostmap.\n   * @emits ServiceCatalog#preauthorized\n   * @emits ServiceCatalog#postauthorized\n   * @param {string} serviceGroup\n   * @param {object} serviceHostmap\n   * @returns {Services}\n   */\n  updateServiceUrls(serviceGroup, serviceHostmap) {\n    const currentServiceUrls = this.serviceGroups[serviceGroup];\n\n    const unusedUrls = currentServiceUrls.filter(\n      (serviceUrl) => serviceHostmap.every(\n        (item) => item.name !== serviceUrl.name\n      )\n    );\n\n    this._unloadServiceUrls(serviceGroup, unusedUrls);\n\n    serviceHostmap.forEach((serviceObj) => {\n      const service = this._getUrl(serviceObj.name, serviceGroup);\n\n      if (service) {\n        service.defaultUrl = serviceObj.defaultUrl;\n        service.hosts = serviceObj.hosts || [];\n      }\n      else {\n        this._loadServiceUrls(serviceGroup, [new ServiceUrl({\n          ...serviceObj\n        })]);\n      }\n    });\n\n    this.status[serviceGroup].ready = true;\n    this.trigger(serviceGroup);\n\n    return this;\n  },\n\n  /**\n   * Wait until the service catalog is available,\n   * or reject after a timeout of 60 seconds.\n   * @param {string} serviceGroup\n   * @param {number} [timeout] - in seconds\n   * @returns {Promise<void>}\n   */\n  waitForCatalog(serviceGroup, timeout) {\n    return new Promise((resolve, reject) => {\n      if (this.status[serviceGroup].ready) {\n        resolve();\n      }\n\n      const timeoutTimer = setTimeout(() => reject(\n        new Error(`services: timeout occured while waiting for '${serviceGroup}' catalog to populate`)\n      ), (timeout) ? timeout * 1000 : 60000);\n\n      this.once(serviceGroup, () => {\n        clearTimeout(timeoutTimer);\n        resolve();\n      });\n    });\n  }\n});\n/* eslint-enable no-underscore-dangle */\n\nexport default ServiceCatalog;\n"],"mappings":"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"}