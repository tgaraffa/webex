{"version":3,"names":["debug","require","AttachmentActions","WebexPlugin","extend","initialize","args","prototype","listen","createEventEnvelope","webex","SDK_EVENT","EXTERNAL","RESOURCE","ATTACHMENT_ACTIONS","then","envelope","eventEnvelope","internal","mercury","connect","listenTo","INTERNAL","WEBEX_ACTIVITY","event","onWebexApiEvent","create","attachmentAction","request","method","service","resource","body","res","get","id","items","activity","data","verb","ACTIVITY_VERB","CARD_ACTION","createdEvent","getattachmentActionEvent","EVENT_TYPE","CREATED","trigger","sdkEvent","cluster","getHydraClusterString","target","url","created","published","actorId","constructHydraId","hydraTypes","PEOPLE","actor","entryUUID","roomId","ROOM","messageId","MESSAGE","parent","personId","ATTACHMENT_ACTION","object","inputs","type","objectType","e","logger","error","message"],"sources":["attachmentActions.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2017 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport {\n  WebexPlugin\n} from '@webex/webex-core';\nimport {\n  SDK_EVENT,\n  createEventEnvelope,\n  constructHydraId,\n  getHydraClusterString,\n  hydraTypes\n} from '@webex/common';\nimport {cloneDeep} from 'lodash';\n\nconst debug = require('debug')('attachmentActions');\n\n\n/**\n * @typedef {Object} AttachmentActionObject\n * @property {string} id - (server generated) Unique identifier for the attachment action\n * @property {string} messageId - The ID of the message in which attachment action is to be performed\n * @property {string} type - The type of attachment action eg., submit\n * @property {Object} inputs - The inputs for form fields in attachment message\n * @property {string} personId - (server generated) The ID for the author of the attachment action\n * @property {string} roomId - (server generated) The ID for the room of the message\n * @property {isoDate} created - (server generated) The date and time that the message was created\n */\n\n/**\n * AttachmentActions are events that communicate information when a user clicks on an\n * Action.Submit button in a card displayed in Webex\n * Information conveyed in an AttachmentAction includes details about the user that\n * clicked the button along with any card specific inputs. See the\n * {@link https://developer.webex.com/docs/api/v1/attachment-actions|Attachments Actions API Documentation}\n * for more details\n * @class\n */\nconst AttachmentActions = WebexPlugin.extend({\n  /**\n   * Initializer used to generate AttachmentActions\n   * as a plugin wrapped around the provided arguments.\n   * @private\n   * @see WebexPlugin.initialize\n   * @param  {...any} args\n   * @returns {undefined}\n   */\n  initialize(...args) {\n    Reflect.apply(WebexPlugin.prototype.initialize, this, args);\n  },\n\n  /**\n   * Register to listen for incoming attachmentAction events\n   * This is an alternate approach to registering for attachmentAction webhooks.\n   * The events passed to any registered handlers will be similar to the webhook JSON,\n   * but will omit webhook specific fields such as name, secret, url, etc.\n   * The attachmentActions.listen() event objects can also include additional fields not\n   * available in the webhook's JSON payload, specifically: `inputs`.\n   * To utilize the `listen()` method, the authorization token used\n   * will need to have `spark:all` and `spark:kms` scopes enabled.\n   * Note that by configuring your application to enable or disable `spark:all`\n   * via its configuration page will also enable or disable `spark:kms`.\n   * See the <a href=\"https://webex.github.io/webex-js-sdk/samples/browser-socket/\">Sample App</a>\n   * for more details.\n   * @instance\n   * @memberof Messages\n   * @returns {Promise}\n   * @example\n   * webex.attachmentActions.listen()\n   *   .then(() => {\n   *     console.log('listening to attachmentActions events');\n   *     webex.attachmentActions.on('created', (event) => console.log(`Got an attachmentActions:created event:\\n${event}`));\n   *   })\n   *   .catch((e) => console.error(`Unable to register for attachmentAction events: ${e}`));\n   * // Some app logic...\n   * // WHen it is time to cleanup\n   * webex.attachmentActions.stopListening();\n   * webex.attachmentActions.off('created');\n   */\n  listen() {\n    // Create a common envelope that we will wrap all events in\n    return createEventEnvelope(this.webex,\n      SDK_EVENT.EXTERNAL.RESOURCE.ATTACHMENT_ACTIONS)\n      .then((envelope) => {\n        this.eventEnvelope = envelope;\n\n        // Register to listen to events\n        return this.webex.internal.mercury.connect().then(() => {\n          this.listenTo(this.webex.internal.mercury,\n            SDK_EVENT.INTERNAL.WEBEX_ACTIVITY,\n            (event) => this.onWebexApiEvent(event));\n        });\n      });\n  },\n\n  /**\n     * Post a new attachment action for a message with attachment.\n     * @instance\n     * @memberof AttachmentActions\n     * @param {AttachmentActionObject} attachmentAction\n     * @returns {Promise<AttachmentActionObject>}\n     * @example\n     * webex.rooms.create({title: 'Create Message with card Example'})\n     *   .then(function(room) {\n     *     return webex.messages.create({\n     *       text: 'Howdy!',\n     *       roomId: room.id,\n     *       attachments:[ {\n     *          contentType: 'application/vnd.microsoft.card.adaptive',\n     *         content: {\n     *           type: 'AdaptiveCard',\n     *           version: '1.0',\n     *           body: [\n     *            {\n     *             type: 'TextBlock',\n     *             text: '',\n     *             size: 'large'\n     *             },\n     *           {\n     *             type: 'TextBlock',\n     *             text: 'Adaptive Cards',\n     *             separation: 'none'\n     *           }\n     *           {\n     *           type: 'Input.Date',\n     *           id: 'dueDate'\n     *           }\n     *       ],\n     *     actions: [\n     *         {\n     *             type: 'Action.Submit',\n     *             title: 'Due Date'\n     *         }\n     *     ]\n     *   }\n     *  }]\n     *     });\n     *   })\n     *   .then(function(message) {\n     *    return webex.attachmentActions.create({\n     *      type: 'submit',\n     *      messageId: message.id,\n     *      inputs:{\n     *        dueDate: '26/06/1995'\n     *      }\n     *    })\n     *    .then(function(attachmentAction)){\n     *      var assert = require('assert');\n     *      assert(attachmentAction.id);\n     *      assert(attachmentAction.type);\n     *      assert(attachmentAction.personId);\n     *      assert(attachmentAction.inputs);\n     *      assert(attachmentAction.messageId);\n     *      assert(attachmentAction.roomId);\n     *      assert(attachmentAction.created);\n     *      return 'success';\n     *     }\n     *   });\n     *   // => success\n     */\n  create(attachmentAction) {\n    return this.request({\n      method: 'POST',\n      service: 'hydra',\n      resource: 'attachment/actions',\n      body: attachmentAction\n    })\n      .then((res) => res.body);\n  },\n\n  /**\n   * Returns a single attachment action.\n   * @instance\n   * @memberof AttachmentActions\n   * @param {string} attachmentAction\n   * @returns {Promise<AttachmentActionObject>}\n   * @example\n   * var attachmentAction;\n   * webex.rooms.create({title: 'Get Message Example'})\n   *   .then(function(room) {\n   *     return webex.messages.create({\n   *       text: 'Howdy!',\n   *       roomId: room.id,\n   *       attachments:[ {\n   *          contentType: 'application/vnd.microsoft.card.adaptive',\n   *         content: {\n   *           type: 'AdaptiveCard',\n   *           version: '1.0',\n   *           body: [\n   *            {\n   *             type: 'TextBlock',\n   *             text: '',\n   *             size: 'large'\n   *             },\n   *           {\n   *             type: 'TextBlock',\n   *             text: 'Adaptive Cards',\n   *             separation: 'none'\n   *           },\n   *           {\n   *           type: 'Input.Date',\n   *           id: 'dueDate'\n   *           }\n   *       ],\n   *     actions: [\n   *         {\n   *             type: 'Action.Submit',\n   *             title: 'Due Date'\n   *         }\n   *     ]\n   *   }\n   *  }]\n   *     });\n   *   })\n   *   .then(function(message) {\n   *     return webex.attachmentActions.create({\n   *      type: 'submit',\n   *      messageId: message.id,\n   *      inputs:{\n   *        dueDate: '26/06/1995'\n   *      });\n   *   })\n   *   .then(function(attachmentAction) {\n   *     return webex.attachmentActions.get(attachmentAction.id)\n   *   })\n   *    .then(function(attachmentAction){\n   *        var assert = require('assert');\n   *        assert.deepEqual(attachmentAction, attachmentAction);\n   *        return 'success';\n   *      })\n   *   // => success\n   */\n  get(attachmentAction) {\n    const id = attachmentAction.id || attachmentAction;\n\n    return this.request({\n      service: 'hydra',\n      resource: `attachment/actions/${id}`\n    })\n      .then((res) => res.body.items || res.body);\n  },\n\n  /**\n   * This function is called when an internal mercury events fires,\n   * if the user registered for these events with the listen() function.\n   * External users of the SDK should not call this function\n   * @private\n   * @memberof AttachmentAction\n   * @param {Object} event\n   * @returns {void}\n   */\n  onWebexApiEvent(event) {\n    const {activity} = event.data;\n\n    /* eslint-disable no-case-declarations */\n    switch (activity.verb) {\n      case SDK_EVENT.INTERNAL.ACTIVITY_VERB.CARD_ACTION:\n        const createdEvent =\n          this.getattachmentActionEvent(activity,\n            SDK_EVENT.EXTERNAL.EVENT_TYPE.CREATED);\n\n        if (createdEvent) {\n          debug(`attachmentAction \"created\" payload: \\\n            ${JSON.stringify(createdEvent)}`);\n          this.trigger(SDK_EVENT.EXTERNAL.EVENT_TYPE.CREATED, createdEvent);\n        }\n        break;\n\n      default: {\n        break;\n      }\n    }\n  },\n\n  /**\n   * Constructs the data object for an event on the attachmentAction resource,\n   * adhering to Hydra's Webehook data structure messages.\n   * External users of the SDK should not call this function\n   * @private\n   * @memberof AttachmentAction\n   * @param {Object} activity from mercury\n   * @param {Object} event type of \"webhook\" event\n   * @returns {Object} constructed event\n   */\n  getattachmentActionEvent(activity, event) {\n    try {\n      const sdkEvent = cloneDeep(this.eventEnvelope);\n      const cluster = getHydraClusterString(this.webex, activity.target.url);\n\n      sdkEvent.event = event;\n      sdkEvent.data.created = activity.published;\n      sdkEvent.actorId =\n        constructHydraId(hydraTypes.PEOPLE, activity.actor.entryUUID, cluster);\n      sdkEvent.data.roomId =\n        constructHydraId(hydraTypes.ROOM, activity.target.id, cluster);\n      sdkEvent.data.messageId =\n        constructHydraId(hydraTypes.MESSAGE, activity.parent.id, cluster);\n      sdkEvent.data.personId =\n        constructHydraId(hydraTypes.PEOPLE, activity.actor.entryUUID, cluster);\n      // Seems like it would be nice to have this, but its not in the hydra webhook\n      // sdkEvent.data.personEmail =\n      //   activity.actor.emailAddress || activity.actor.entryEmail;\n\n      sdkEvent.data.id =\n        constructHydraId(hydraTypes.ATTACHMENT_ACTION, activity.id, cluster);\n      if (activity.object.inputs) {\n        sdkEvent.data.inputs = activity.object.inputs;\n      }\n      sdkEvent.data.type = activity.object.objectType;\n\n      return sdkEvent;\n    }\n    catch (e) {\n      this.webex.logger.error(`Unable to generate SDK event from mercury \\\n'socket activity for attachmentAction:${event} event: ${e.message}`);\n\n      return null;\n    }\n  }\n\n});\n\nexport default AttachmentActions;\n"],"mappings":";;;;;;;;;;;;;;;;;;AAIA;;AAGA;;AAPA;AACA;AACA;AAcA,IAAMA,KAAK,GAAGC,OAAO,CAAC,OAAD,CAAP,CAAiB,mBAAjB,CAAd;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;AACA,IAAMC,iBAAiB,GAAGC,sBAAA,CAAYC,MAAZ,CAAmB;EAC3C;AACF;AACA;AACA;AACA;AACA;AACA;AACA;EACEC,UAT2C,wBASvB;IAAA,kCAANC,IAAM;MAANA,IAAM;IAAA;;IAClB,oBAAcH,sBAAA,CAAYI,SAAZ,CAAsBF,UAApC,EAAgD,IAAhD,EAAsDC,IAAtD;EACD,CAX0C;;EAa3C;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACEE,MAzC2C,oBAyClC;IAAA;;IACP;IACA,OAAO,IAAAC,2BAAA,EAAoB,KAAKC,KAAzB,EACLC,iBAAA,CAAUC,QAAV,CAAmBC,QAAnB,CAA4BC,kBADvB,EAEJC,IAFI,CAEC,UAACC,QAAD,EAAc;MAClB,KAAI,CAACC,aAAL,GAAqBD,QAArB,CADkB,CAGlB;;MACA,OAAO,KAAI,CAACN,KAAL,CAAWQ,QAAX,CAAoBC,OAApB,CAA4BC,OAA5B,GAAsCL,IAAtC,CAA2C,YAAM;QACtD,KAAI,CAACM,QAAL,CAAc,KAAI,CAACX,KAAL,CAAWQ,QAAX,CAAoBC,OAAlC,EACER,iBAAA,CAAUW,QAAV,CAAmBC,cADrB,EAEE,UAACC,KAAD;UAAA,OAAW,KAAI,CAACC,eAAL,CAAqBD,KAArB,CAAX;QAAA,CAFF;MAGD,CAJM,CAAP;IAKD,CAXI,CAAP;EAYD,CAvD0C;;EAyD3C;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACEE,MA1H2C,kBA0HpCC,gBA1HoC,EA0HlB;IACvB,OAAO,KAAKC,OAAL,CAAa;MAClBC,MAAM,EAAE,MADU;MAElBC,OAAO,EAAE,OAFS;MAGlBC,QAAQ,EAAE,oBAHQ;MAIlBC,IAAI,EAAEL;IAJY,CAAb,EAMJZ,IANI,CAMC,UAACkB,GAAD;MAAA,OAASA,GAAG,CAACD,IAAb;IAAA,CAND,CAAP;EAOD,CAlI0C;;EAoI3C;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACEE,GAlM2C,eAkMvCP,gBAlMuC,EAkMrB;IACpB,IAAMQ,EAAE,GAAGR,gBAAgB,CAACQ,EAAjB,IAAuBR,gBAAlC;IAEA,OAAO,KAAKC,OAAL,CAAa;MAClBE,OAAO,EAAE,OADS;MAElBC,QAAQ,+BAAwBI,EAAxB;IAFU,CAAb,EAIJpB,IAJI,CAIC,UAACkB,GAAD;MAAA,OAASA,GAAG,CAACD,IAAJ,CAASI,KAAT,IAAkBH,GAAG,CAACD,IAA/B;IAAA,CAJD,CAAP;EAKD,CA1M0C;;EA4M3C;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACEP,eArN2C,2BAqN3BD,KArN2B,EAqNpB;IACrB,IAAOa,QAAP,GAAmBb,KAAK,CAACc,IAAzB,CAAOD,QAAP;IAEA;;IACA,QAAQA,QAAQ,CAACE,IAAjB;MACE,KAAK5B,iBAAA,CAAUW,QAAV,CAAmBkB,aAAnB,CAAiCC,WAAtC;QACE,IAAMC,YAAY,GAChB,KAAKC,wBAAL,CAA8BN,QAA9B,EACE1B,iBAAA,CAAUC,QAAV,CAAmBgC,UAAnB,CAA8BC,OADhC,CADF;;QAIA,IAAIH,YAAJ,EAAkB;UAChB1C,KAAK,6DACD,wBAAe0C,YAAf,CADC,EAAL;UAEA,KAAKI,OAAL,CAAanC,iBAAA,CAAUC,QAAV,CAAmBgC,UAAnB,CAA8BC,OAA3C,EAAoDH,YAApD;QACD;;QACD;;MAEF;QAAS;UACP;QACD;IAfH;EAiBD,CA1O0C;;EA4O3C;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACEC,wBAtP2C,oCAsPlBN,QAtPkB,EAsPRb,KAtPQ,EAsPD;IACxC,IAAI;MACF,IAAMuB,QAAQ,GAAG,yBAAU,KAAK9B,aAAf,CAAjB;MACA,IAAM+B,OAAO,GAAG,IAAAC,6BAAA,EAAsB,KAAKvC,KAA3B,EAAkC2B,QAAQ,CAACa,MAAT,CAAgBC,GAAlD,CAAhB;MAEAJ,QAAQ,CAACvB,KAAT,GAAiBA,KAAjB;MACAuB,QAAQ,CAACT,IAAT,CAAcc,OAAd,GAAwBf,QAAQ,CAACgB,SAAjC;MACAN,QAAQ,CAACO,OAAT,GACE,IAAAC,wBAAA,EAAiBC,kBAAA,CAAWC,MAA5B,EAAoCpB,QAAQ,CAACqB,KAAT,CAAeC,SAAnD,EAA8DX,OAA9D,CADF;MAEAD,QAAQ,CAACT,IAAT,CAAcsB,MAAd,GACE,IAAAL,wBAAA,EAAiBC,kBAAA,CAAWK,IAA5B,EAAkCxB,QAAQ,CAACa,MAAT,CAAgBf,EAAlD,EAAsDa,OAAtD,CADF;MAEAD,QAAQ,CAACT,IAAT,CAAcwB,SAAd,GACE,IAAAP,wBAAA,EAAiBC,kBAAA,CAAWO,OAA5B,EAAqC1B,QAAQ,CAAC2B,MAAT,CAAgB7B,EAArD,EAAyDa,OAAzD,CADF;MAEAD,QAAQ,CAACT,IAAT,CAAc2B,QAAd,GACE,IAAAV,wBAAA,EAAiBC,kBAAA,CAAWC,MAA5B,EAAoCpB,QAAQ,CAACqB,KAAT,CAAeC,SAAnD,EAA8DX,OAA9D,CADF,CAZE,CAcF;MACA;MACA;;MAEAD,QAAQ,CAACT,IAAT,CAAcH,EAAd,GACE,IAAAoB,wBAAA,EAAiBC,kBAAA,CAAWU,iBAA5B,EAA+C7B,QAAQ,CAACF,EAAxD,EAA4Da,OAA5D,CADF;;MAEA,IAAIX,QAAQ,CAAC8B,MAAT,CAAgBC,MAApB,EAA4B;QAC1BrB,QAAQ,CAACT,IAAT,CAAc8B,MAAd,GAAuB/B,QAAQ,CAAC8B,MAAT,CAAgBC,MAAvC;MACD;;MACDrB,QAAQ,CAACT,IAAT,CAAc+B,IAAd,GAAqBhC,QAAQ,CAAC8B,MAAT,CAAgBG,UAArC;MAEA,OAAOvB,QAAP;IACD,CA1BD,CA2BA,OAAOwB,CAAP,EAAU;MACR,KAAK7D,KAAL,CAAW8D,MAAX,CAAkBC,KAAlB,2FACkCjD,KADlC,qBACkD+C,CAAC,CAACG,OADpD;MAGA,OAAO,IAAP;IACD;EACF,CAxR0C;EAAA;AAAA,CAAnB,CAA1B;;eA4RexE,iB"}