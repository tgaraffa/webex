{"version":3,"names":["NetworkQualityMonitor","config","indicatorTypes","PACKETLOSS","LATENCY","JITTER","frequencyTypes","UPLINK","DOWNLINK","networkQualityScore","networkQualityStatus","STATS","VIDEO_CORRELATE","AUDIO_CORRELATE","SHARE_CORRELATE","mediaType","emit","file","function","EVENT_TRIGGERS","NETWORK_QUALITY","emitNetworkQuality","remoteRtpResults","statsAnalyzerCurrentStats","roundTripTimeInMilliseconds","roundTripTime","jitterInMilliseconds","jitter","currentPacketLossRatio","send","determinePacketLoss","videoPacketLossRatioThreshold","determineLatency","rttThreshold","deterMineJitter","jitterThreshold","determineIfUndefined","value","acceptable","updateNetworkQualityStatus","EventsScope"],"sources":["index.js"],"sourcesContent":["import EventsScope from '../common/events/events-scope';\nimport {EVENT_TRIGGERS, STATS} from '../constants';\n\n\n/**\n  * Meeting - network quality event\n  * Emitted on each interval of retrieving stats Analyzer data\n  * @event network:quality\n  * @type {Object}\n  * @property {string} mediaType {video|audio}\n  * @property {number} networkQualityScore - value determined in determineUplinkNetworkQuality\n  * @memberof NetworkQualityMonitor\n  */\n/**\n * NetworkQualityMonitor class that will emit events based on detected quality\n *\n * @class NetworkQualityMonitor\n * @extends {EventsScope}\n */\nexport default class NetworkQualityMonitor extends EventsScope {\n  /**\n   * Creates a new instance of NetworkQualityMonitor\n   * @constructor\n   * @public\n   * @param {Object} config\n   * @property {Object} indicatorTypes - network properties used to evaluate network quality used as constants\n   * @property {Object} frequencyTypes - frequency properties used as constants {uplink|send} {downlink|receive}\n   * @property {number} networkQualityScore  - 0|1 1 is acceptable 0 is bad/unknown\n   * @property {Object} networkQualityStatus - hash object based on indicatorTypes and frequencyTypes\n   * @property {string} mediaType - audio|video\n   */\n  constructor(config) {\n    super();\n    this.config = config;\n    this.indicatorTypes = Object.freeze({\n      PACKETLOSS: 'packetLoss',\n      LATENCY: 'latency',\n      JITTER: 'jitter'\n    });\n    this.frequencyTypes = Object.freeze({\n      UPLINK: 'uplink',\n      DOWNLINK: 'downlink'\n    });\n    this.networkQualityScore = 1;\n    this.networkQualityStatus = {\n      [this.frequencyTypes.UPLINK]: {\n        [STATS.VIDEO_CORRELATE]: {},\n        [STATS.AUDIO_CORRELATE]: {},\n        [STATS.SHARE_CORRELATE]: {}\n      }\n    };\n    this.mediaType = null;\n  }\n\n  /**\n   * emits NETWORK_QUALITY event on meeting with payload of media type and uplinkNetworkQuality score\n   *\n   * @memberof NetworkQualityMonitor\n   * @returns {void}\n   */\n  emitNetworkQuality() {\n    this.emit(\n      {\n        file: 'networkQualityMonitor',\n        function: 'emitNetworkQuality'\n      },\n      EVENT_TRIGGERS.NETWORK_QUALITY,\n      {\n        mediaType: this.mediaType,\n        networkQualityScore: this.networkQualityScore\n      }\n    );\n  }\n\n  /**\n   * invokes emitNetworkQuality method resets values back to default\n   * @returns {void}\n   * @memberof NetworkQualityMonitor\n   */\n  updateNetworkQualityStatus() {\n    this.emitNetworkQuality();\n\n    // reset values\n    this.networkQualityScore = 1;\n    this.mediaType = null;\n  }\n\n\n  /**\n   * filter data to determine uplink network quality, invoked on same interval as stats analyzer remote-inbout-rtp\n   * @param {Object} configObj\n   * @param {string} configObj.mediaType {audio|video}\n   * @param {RTCStats} configObj.remoteRtpResults RTC stats remote obj\n   * @param {Object} configObj.statsAnalyzerCurrentStats statsResults\n   * @returns {void}\n   * @public\n   * @memberof NetworkQualityMonitor\n   */\n  determineUplinkNetworkQuality({mediaType, remoteRtpResults, statsAnalyzerCurrentStats}) {\n    const roundTripTimeInMilliseconds = remoteRtpResults.roundTripTime * 1000;\n    const jitterInMilliseconds = remoteRtpResults.jitter * 1000;\n    const {currentPacketLossRatio} = statsAnalyzerCurrentStats[mediaType].send;\n\n    this.mediaType = mediaType;\n\n    const {JITTER, PACKETLOSS, LATENCY} = this.indicatorTypes;\n    const {UPLINK} = this.frequencyTypes;\n\n    /**\n     * determines if packetLoss ratio is over threshold set in config\n     * sets networkQualityScore to 0 if over threshold\n     * @returns {boolean}\n     */\n    const determinePacketLoss = () => {\n      if (currentPacketLossRatio >\n        this.config.videoPacketLossRatioThreshold) {\n        this.networkQualityScore = 0;\n\n        return false;\n      }\n\n      return true;\n    };\n\n    /**\n     * determines if round trip time value is over threshold set in config\n     * sets networkQualityScore to 0 if over threshold\n     * @returns {boolean}\n     */\n    const determineLatency = () => {\n      if (roundTripTimeInMilliseconds > this.config.rttThreshold) {\n        this.networkQualityScore = 0;\n\n        return false;\n      }\n\n      return true;\n    };\n\n    /**\n     * determines if jitter value is over threshold in config\n     * sets networkQualityScore to 0 if over threshold\n     * @returns {boolean}\n     */\n    const deterMineJitter = () => {\n      if (jitterInMilliseconds > this.config.jitterThreshold) {\n        this.networkQualityScore = 0;\n\n        return false;\n      }\n\n      return true;\n    };\n\n    /**\n     * returns null if val is specifically undefined\n     * @param {(number|undefined)} value\n     * @returns {(number|null)}\n     */\n    const determineIfUndefined = (value) => (typeof value === 'undefined' ? null : value);\n\n    /**\n     * Values for some browsers specifically Safari will be undefined we explicitly set to null\n     * https://bugs.webkit.org/show_bug.cgi?id=206645\n     * https://bugs.webkit.org/show_bug.cgi?id=212668\n     */\n    // PACKET LOSS\n    this.networkQualityStatus[UPLINK][mediaType][PACKETLOSS] = {\n      acceptable: determinePacketLoss(),\n      value: determineIfUndefined(currentPacketLossRatio)\n    };\n\n\n    // LATENCY measured in Round trip time\n    this.networkQualityStatus[UPLINK][mediaType][LATENCY] = {\n      acceptable: determineLatency(),\n      value: determineIfUndefined(remoteRtpResults.roundTripTime)\n    };\n\n    // JITTER\n    this.networkQualityStatus[UPLINK][mediaType][JITTER] = {\n      acceptable: deterMineJitter(),\n      value: determineIfUndefined(remoteRtpResults.jitter)\n    };\n\n    this.updateNetworkQualityStatus();\n  }\n\n  /**\n   * Get the current status of network quaility object - networkQualityStatus\n   * @returns {Object}\n   * @public\n   */\n  get networkQualityStats() {\n    const {UPLINK} = this.frequencyTypes;\n\n    return this.networkQualityStatus[UPLINK];\n  }\n}\n"],"mappings":";;;;;;;;;;;;;;;;;;;;;;;;;;;;AAAA;;AACA;;;;;;AAGA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AACA;AACA;AACA;AACA;AACA;AACA;IACqBA,qB;;;;;EACnB;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;EACE,+BAAYC,MAAZ,EAAoB;IAAA;;IAAA;;IAAA;IAClB;IACA,MAAKA,MAAL,GAAcA,MAAd;IACA,MAAKC,cAAL,GAAsB,qBAAc;MAClCC,UAAU,EAAE,YADsB;MAElCC,OAAO,EAAE,SAFyB;MAGlCC,MAAM,EAAE;IAH0B,CAAd,CAAtB;IAKA,MAAKC,cAAL,GAAsB,qBAAc;MAClCC,MAAM,EAAE,QAD0B;MAElCC,QAAQ,EAAE;IAFwB,CAAd,CAAtB;IAIA,MAAKC,mBAAL,GAA2B,CAA3B;IACA,MAAKC,oBAAL,qCACG,MAAKJ,cAAL,CAAoBC,MADvB,oFAEKI,gBAAA,CAAMC,eAFX,EAE6B,EAF7B,wDAGKD,gBAAA,CAAME,eAHX,EAG6B,EAH7B,wDAIKF,gBAAA,CAAMG,eAJX,EAI6B,EAJ7B;IAOA,MAAKC,SAAL,GAAiB,IAAjB;IApBkB;EAqBnB;EAED;AACF;AACA;AACA;AACA;AACA;;;;;WACE,8BAAqB;MACnB,KAAKC,IAAL,CACE;QACEC,IAAI,EAAE,uBADR;QAEEC,QAAQ,EAAE;MAFZ,CADF,EAKEC,yBAAA,CAAeC,eALjB,EAME;QACEL,SAAS,EAAE,KAAKA,SADlB;QAEEN,mBAAmB,EAAE,KAAKA;MAF5B,CANF;IAWD;IAED;AACF;AACA;AACA;AACA;;;;WACE,sCAA6B;MAC3B,KAAKY,kBAAL,GAD2B,CAG3B;;MACA,KAAKZ,mBAAL,GAA2B,CAA3B;MACA,KAAKM,SAAL,GAAiB,IAAjB;IACD;IAGD;AACF;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;;;WACE,6CAAwF;MAAA;;MAAA,IAAzDA,SAAyD,QAAzDA,SAAyD;MAAA,IAA9CO,gBAA8C,QAA9CA,gBAA8C;MAAA,IAA5BC,yBAA4B,QAA5BA,yBAA4B;MACtF,IAAMC,2BAA2B,GAAGF,gBAAgB,CAACG,aAAjB,GAAiC,IAArE;MACA,IAAMC,oBAAoB,GAAGJ,gBAAgB,CAACK,MAAjB,GAA0B,IAAvD;MACA,IAAOC,sBAAP,GAAiCL,yBAAyB,CAACR,SAAD,CAAzB,CAAqCc,IAAtE,CAAOD,sBAAP;MAEA,KAAKb,SAAL,GAAiBA,SAAjB;MAEA,2BAAsC,KAAKb,cAA3C;MAAA,IAAOG,MAAP,wBAAOA,MAAP;MAAA,IAAeF,UAAf,wBAAeA,UAAf;MAAA,IAA2BC,OAA3B,wBAA2BA,OAA3B;MACA,IAAOG,MAAP,GAAiB,KAAKD,cAAtB,CAAOC,MAAP;MAEA;AACJ;AACA;AACA;AACA;;MACI,IAAMuB,mBAAmB,GAAG,SAAtBA,mBAAsB,GAAM;QAChC,IAAIF,sBAAsB,GACxB,MAAI,CAAC3B,MAAL,CAAY8B,6BADd,EAC6C;UAC3C,MAAI,CAACtB,mBAAL,GAA2B,CAA3B;UAEA,OAAO,KAAP;QACD;;QAED,OAAO,IAAP;MACD,CATD;MAWA;AACJ;AACA;AACA;AACA;;;MACI,IAAMuB,gBAAgB,GAAG,SAAnBA,gBAAmB,GAAM;QAC7B,IAAIR,2BAA2B,GAAG,MAAI,CAACvB,MAAL,CAAYgC,YAA9C,EAA4D;UAC1D,MAAI,CAACxB,mBAAL,GAA2B,CAA3B;UAEA,OAAO,KAAP;QACD;;QAED,OAAO,IAAP;MACD,CARD;MAUA;AACJ;AACA;AACA;AACA;;;MACI,IAAMyB,eAAe,GAAG,SAAlBA,eAAkB,GAAM;QAC5B,IAAIR,oBAAoB,GAAG,MAAI,CAACzB,MAAL,CAAYkC,eAAvC,EAAwD;UACtD,MAAI,CAAC1B,mBAAL,GAA2B,CAA3B;UAEA,OAAO,KAAP;QACD;;QAED,OAAO,IAAP;MACD,CARD;MAUA;AACJ;AACA;AACA;AACA;;;MACI,IAAM2B,oBAAoB,GAAG,SAAvBA,oBAAuB,CAACC,KAAD;QAAA,OAAY,OAAOA,KAAP,KAAiB,WAAjB,GAA+B,IAA/B,GAAsCA,KAAlD;MAAA,CAA7B;MAEA;AACJ;AACA;AACA;AACA;MACI;;;MACA,KAAK3B,oBAAL,CAA0BH,MAA1B,EAAkCQ,SAAlC,EAA6CZ,UAA7C,IAA2D;QACzDmC,UAAU,EAAER,mBAAmB,EAD0B;QAEzDO,KAAK,EAAED,oBAAoB,CAACR,sBAAD;MAF8B,CAA3D,CArEsF,CA2EtF;;MACA,KAAKlB,oBAAL,CAA0BH,MAA1B,EAAkCQ,SAAlC,EAA6CX,OAA7C,IAAwD;QACtDkC,UAAU,EAAEN,gBAAgB,EAD0B;QAEtDK,KAAK,EAAED,oBAAoB,CAACd,gBAAgB,CAACG,aAAlB;MAF2B,CAAxD,CA5EsF,CAiFtF;;MACA,KAAKf,oBAAL,CAA0BH,MAA1B,EAAkCQ,SAAlC,EAA6CV,MAA7C,IAAuD;QACrDiC,UAAU,EAAEJ,eAAe,EAD0B;QAErDG,KAAK,EAAED,oBAAoB,CAACd,gBAAgB,CAACK,MAAlB;MAF0B,CAAvD;MAKA,KAAKY,0BAAL;IACD;IAED;AACF;AACA;AACA;AACA;;;;SACE,eAA0B;MACxB,IAAOhC,MAAP,GAAiB,KAAKD,cAAtB,CAAOC,MAAP;MAEA,OAAO,KAAKG,oBAAL,CAA0BH,MAA1B,CAAP;IACD;;;EAlLgDiC,oB"}