{"version":3,"names":["MeetingsUtil","getMeetingAddedType","type","_LOCUS_ID_","_INCOMING_","_CREATED_","handleRoapMercury","envelope","meetingCollection","data","eventType","LOCUSEVENT","MESSAGE_ROAP","meeting","getByKey","CORRELATION_ID","correlationId","roap","roapEvent","checkForCorrelationId","deviceUrl","locus","devices","self","foundDevice","find","device","url","parseDefaultSiteFromMeetingPreferences","userPreferences","result","sites","defaultSite","site","default","siteUrl","hasH264Codec","hasCodec","pc","window","RTCPeerConnection","createOffer","offerToReceiveVideo","offer","sdp","match","close","LoggerProxy","logger","warn","checkH264Support","options","firstChecked","disableNotifications","delay","maxDuration","shouldTrigger","undefined","shouldStopChecking","Trigger","trigger","file","function","EVENT_TRIGGERS","MEDIA_CODEC_LOADED","log","error","MEDIA_CODEC_MISSING","setTimeout","timestamp","call"],"sources":["util.js"],"sourcesContent":["/* globals window */\n\nimport {\n  _LOCUS_ID_,\n  _INCOMING_,\n  _CREATED_,\n  LOCUSEVENT,\n  CORRELATION_ID,\n  EVENT_TRIGGERS\n} from '../constants';\nimport LoggerProxy from '../common/logs/logger-proxy';\nimport Trigger from '../common/events/trigger-proxy';\n\n/**\n  * Meetings Media Codec Missing Event\n  * Emitted when H.264 codec is not\n  * found in the browser.\n  * @event media:codec:missing\n  * @instance\n  * @memberof MeetingsUtil\n  */\n\n/**\n  * Meetings Media Codec Loaded Event\n  * Emitted when H.264 codec has been\n  * loaded in the browser.\n  * @event media:codec:loaded\n  * @instance\n  * @memberof MeetingsUtil\n  */\n\nconst MeetingsUtil = {};\n\nMeetingsUtil.getMeetingAddedType = (type) => (type === _LOCUS_ID_ ? _INCOMING_ : _CREATED_);\n\nMeetingsUtil.handleRoapMercury = (envelope, meetingCollection) => {\n  const {data} = envelope;\n  const {eventType} = data;\n\n  if (eventType === LOCUSEVENT.MESSAGE_ROAP) {\n    const meeting = meetingCollection.getByKey(CORRELATION_ID, data.correlationId);\n\n    if (meeting) {\n      meeting.roap.roapEvent(data);\n    }\n  }\n};\n\nMeetingsUtil.checkForCorrelationId = (deviceUrl, locus) => {\n  let devices = [];\n\n  if (locus) {\n    if (locus && locus.self && locus.self.devices) {\n      devices = locus.self.devices;\n    }\n\n    const foundDevice = devices.find((device) => device.url === deviceUrl);\n\n    if (foundDevice && foundDevice.correlationId) {\n      return foundDevice.correlationId;\n    }\n  }\n\n  return false;\n};\n\nMeetingsUtil.parseDefaultSiteFromMeetingPreferences = (userPreferences) => {\n  let result = '';\n\n  if (userPreferences && userPreferences.sites) {\n    const defaultSite = userPreferences.sites.find((site) => site.default);\n\n    if (defaultSite) {\n      result = defaultSite.siteUrl;\n    }\n  }\n\n  return result;\n};\n\n/**\n * Will check to see if the H.264 media codec is supported.\n * @async\n * @private\n * @returns {Promise<boolean>}\n */\nMeetingsUtil.hasH264Codec = async () => {\n  let hasCodec = false;\n\n  try {\n    const pc = new window.RTCPeerConnection();\n    const offer = await pc.createOffer({offerToReceiveVideo: true});\n\n    if (offer.sdp.match(/^a=rtpmap:\\d+\\s+H264\\/\\d+/m)) {\n      hasCodec = true;\n    }\n    pc.close();\n  }\n  catch (error) {\n    LoggerProxy.logger.warn('Meetings:util#hasH264Codec --> Error creating peerConnection for H.264 test.');\n  }\n\n  return hasCodec;\n};\n\n\n/**\n * Notifies the user whether or not the H.264\n * codec is present. Will continuously check\n * until max duration.\n * @async\n * @private\n * @param {object} options\n * @param {Number} options.firstChecked Timestamp in milliseconds\n * @param {boolean} options.disableNotifications Default is false. Boolean to enable/disable notification and events\n * @returns {undefined}\n */\nMeetingsUtil.checkH264Support = async function checkH264Support(options) {\n  const {hasH264Codec} = MeetingsUtil;\n  const {firstChecked, disableNotifications} = options || {};\n  const delay = 5e3; // ms\n  const maxDuration = 3e5; // ms\n  const shouldTrigger = (firstChecked === undefined);\n  const shouldStopChecking = firstChecked && (Date.now() - firstChecked) >= maxDuration;\n\n  // Disable notifications and start H.264 download only\n  if (disableNotifications) {\n    hasH264Codec();\n\n    return;\n  }\n\n  // Codec loaded trigger event notification\n  if (await hasH264Codec()) {\n    Trigger.trigger(\n      this,\n      {\n        file: 'meetings/util',\n        function: 'checkH264Support'\n      },\n      EVENT_TRIGGERS.MEDIA_CODEC_LOADED\n    );\n    LoggerProxy.logger.log('Meetings:util#checkH264Support --> H264 codec loaded successfully.');\n\n    return;\n  }\n\n  // Stop checking if past the timelimit\n  if (shouldStopChecking) {\n    LoggerProxy.logger.error('Meetings:util#checkH264Support --> Timed out waiting for H264 codec to load.');\n\n    return;\n  }\n\n  // Trigger only once\n  if (shouldTrigger) {\n    Trigger.trigger(\n      this,\n      {\n        file: 'meetings/util',\n        function: 'checkH264Support'\n      },\n      EVENT_TRIGGERS.MEDIA_CODEC_MISSING\n    );\n    LoggerProxy.logger.log('Meetings:util#checkH264Support --> H264 codec is missing.');\n  }\n\n  // Keep checking in intervals to see if codec loaded\n  window.setTimeout(() => {\n    const timestamp = firstChecked || Date.now();\n\n    MeetingsUtil.checkH264Support.call(this, {firstChecked: timestamp});\n  }, delay);\n};\n\nexport default MeetingsUtil;\n"],"mappings":"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"}