{"version":3,"names":["Feature","WebexPlugin","extend","namespace","getFeature","keyType","key","options","reject","Error","feature","webex","internal","device","features","get","resolve","full","serialize","value","handleFeatureUpdate","envelope","data","featureToggle","type","toLowerCase","add","merge","listen","listenTo","mercury","setFeature","request","method","api","resource","userId","body","mutable","val","then","res","setBundledFeatures","featureList","forEach","item","partitionedToggles","featureToggles","user","developer","initialize","args","prototype","listenToAndRun","trigger","bind"],"sources":["feature.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport '@webex/internal-plugin-device';\nimport {partition} from 'lodash';\nimport {WebexPlugin} from '@webex/webex-core';\n\nconst Feature = WebexPlugin.extend({\n  namespace: 'Feature',\n\n  /**\n   * Returns the value of the requested feature toggle.\n   * @param {string} keyType <developer|user|entitlement>\n   * @param {string} key\n   * @param {Object} options\n   * @param {boolean} options.full to get full feature record including metadata.\n   * @returns {string|boolean|number|FeatureModel|null}\n   */\n  getFeature(keyType, key, options) {\n    if (keyType !== 'developer' && keyType !== 'user' && keyType !== 'entitlement') {\n      return Promise.reject(new Error('Invalid feature keyType provided. Only `developer`, `user`, and `entitlement` feature toggles are permitted.'));\n    }\n\n    options = options || {};\n\n    const feature = this.webex.internal.device.features[keyType].get(key);\n\n    if (!feature) {\n      return Promise.resolve(null);\n    }\n\n    if (options.full) {\n      return Promise.resolve(feature.serialize());\n    }\n\n    return Promise.resolve(feature.value);\n  },\n\n  /**\n   * Handles a feature toggle update from the server.\n   * @param {Object} envelope\n   * @returns {undefined}\n   */\n  handleFeatureUpdate(envelope) {\n    if (envelope && envelope.data) {\n      const feature = envelope.data.featureToggle;\n      const keyType = feature.type.toLowerCase();\n\n      if (keyType === 'user' || keyType === 'developer') {\n        this.webex.internal.device.features[keyType].add([feature], {merge: true});\n      }\n    }\n  },\n\n  /**\n   * Register to listen for incoming feature events\n   * @instance\n   * @returns {undefined}\n   */\n  listen() {\n    this.listenTo(this.webex.internal.mercury, 'event:featureToggle_update', this.handleFeatureUpdate);\n  },\n\n  /**\n   * Issues request to server to set a value for a feature toggle.\n   * @param {string} keyType <developer|user>\n   * @param {string} key\n   * @param {string} value\n   * @returns {Promise} Refreshes the local device and resolves with the features endpoint's response.\n   */\n  setFeature(keyType, key, value) {\n    // Limit only to developer feature toggles for now.\n    if (keyType !== 'developer' && keyType !== 'user') {\n      return Promise.reject(new Error('Only `developer` and `user` feature toggles can be set.'));\n    }\n\n    return this.request({\n      method: 'POST',\n      api: 'feature',\n      resource: `features/users/${this.webex.internal.device.userId}/${keyType}`,\n      body: {\n        key,\n        mutable: true,\n        val: value\n      }\n    })\n      .then((res) => this.webex.internal.device.features[keyType].add(res.body, {merge: true}));\n  },\n\n  /**\n   * Issues request to server to set a value for a feature toggle.\n   * @param {array} featureList\n   * @returns {Promise} Refreshes the local device and resolves with the features endpoint`s response.\n   */\n  setBundledFeatures(featureList) {\n    featureList.forEach((item) => {\n      item.mutable = item.mutable || 'true';\n      if (item.type !== 'USER' && item.type !== 'DEV') {\n        item.type = 'USER';\n      }\n    });\n\n    return this.request({\n      method: 'POST',\n      api: 'feature',\n      resource: `features/users/${this.webex.internal.device.userId}/toggles`,\n      body: featureList\n    })\n      .then((res) => {\n        const partitionedToggles = partition(res.body.featureToggles, {type: 'USER'});\n\n        this.webex.internal.device.features.user.add(partitionedToggles[0], {merge: true});\n        this.webex.internal.device.features.developer.add(partitionedToggles[1], {merge: true});\n      });\n  },\n\n  initialize(...args) {\n    Reflect.apply(WebexPlugin.prototype.initialize, this, args);\n\n    this.listenToAndRun(this.webex, 'change:internal.device.features.developer', this.trigger.bind(this, 'change:developer'));\n    this.listenToAndRun(this.webex, 'change:internal.device.features.entitlement', this.trigger.bind(this, 'change:entitlement'));\n    this.listenToAndRun(this.webex, 'change:internal.device.features.user', this.trigger.bind(this, 'change:user'));\n  }\n});\n\nexport default Feature;\n"],"mappings":"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"}