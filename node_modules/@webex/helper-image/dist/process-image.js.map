{"version":3,"names":["processImage","file","type","thumbnailMaxWidth","thumbnailMaxHeight","enableThumbnails","logger","fileType","startsWith","resolve","fileDimensions","reject","gm","size","err","thumbnail","thumbnailDimensions","resize","autoOrient","toBuffer","buffer","then","all","catch","errorString","toString","includes","warn","debug"],"sources":["process-image.js"],"sourcesContent":["/*!\n * Copyright (c) 2015-2020 Cisco Systems, Inc. See LICENSE file.\n */\n\nimport gm from 'gm';\nimport {pick} from 'lodash';\n\n/**\n * Measures an image file and produces a thumbnail for it\n * @param {Object} options\n * @param {Blob|ArrayBuffer} options.file\n * @param {Number} options.thumbnailMaxWidth\n * @param {Number} options.thumbnailMaxHeight\n * @param {Boolean} options.enableThumbnails\n * @param {Object} options.logger\n * @returns {Promise<Array>} Buffer, Dimensions, thumbnailDimensions\n */\nexport default function processImage({\n  file, type, thumbnailMaxWidth, thumbnailMaxHeight, enableThumbnails, logger\n}) {\n  const fileType = type || file.type;\n\n  if (!fileType || !fileType.startsWith('image')) {\n    return Promise.resolve();\n  }\n\n  const fileDimensions = new Promise((resolve, reject) => {\n    gm(file).size((err, size) => {\n      if (err) {\n        reject(err);\n\n        return;\n      }\n\n      resolve(pick(size, 'width', 'height'));\n    });\n  });\n\n  let thumbnail, thumbnailDimensions;\n\n  if (enableThumbnails) {\n    thumbnail = new Promise((resolve, reject) => {\n      gm(file).resize(thumbnailMaxWidth, thumbnailMaxHeight)\n        .autoOrient()\n        .toBuffer('PNG', (err, buffer) => {\n          if (err) {\n            reject(err);\n\n            return;\n          }\n\n          resolve(buffer);\n        });\n    });\n\n    thumbnailDimensions = thumbnail.then((buffer) => new Promise((resolve, reject) => {\n      gm(buffer)\n        .size((err, size) => {\n          if (err) {\n            reject(err);\n\n            return;\n          }\n\n          resolve(pick(size, 'width', 'height'));\n        });\n    }));\n  }\n\n\n  return Promise.all([thumbnail, fileDimensions, thumbnailDimensions])\n    .catch((err) => {\n      const errorString = err.toString();\n\n      if (errorString.includes('EPIPE')) {\n        logger.warn(err, 'Is GraphicsMagick installed?');\n\n        return Promise.resolve();\n      }\n\n      if (errorString.includes('No decode delegate for this image format')) {\n        logger.debug(err, 'File does not appear to be an image');\n\n        return Promise.resolve();\n      }\n\n      if (errorString.includes('Stream yields empty buffer')) {\n        logger.debug(err, 'File does not appear to be an image');\n\n        return Promise.resolve();\n      }\n\n      return Promise.reject(err);\n    });\n}\n"],"mappings":"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"}